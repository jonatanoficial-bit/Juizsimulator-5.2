<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Jogo do Juiz ‚Äî Vale Produ√ß√£o</title>
  <!-- React 18 UMD -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body,#root{height:100%;}
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    .scroll-thin::-webkit-scrollbar{width:6px;}
    .scroll-thin::-webkit-scrollbar-thumb{background:#4b5563;border-radius:999px;}
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef} = React;

/* ===================== DADOS FIXOS ===================== */

const ESTADOS = {
  "AC":["Rio Branco"],"AL":["Macei√≥"],"AP":["Macap√°"],"AM":["Manaus"],
  "BA":["Salvador","Feira de Santana","Vit√≥ria da Conquista"],
  "CE":["Fortaleza"],"DF":["Bras√≠lia"],"ES":["Vit√≥ria"],"GO":["Goi√¢nia"],
  "MA":["S√£o Lu√≠s"],"MT":["Cuiab√°"],"MS":["Campo Grande"],
  "MG":["Belo Horizonte","Uberl√¢ndia","Juiz de Fora"],
  "PA":["Bel√©m"],"PB":["Jo√£o Pessoa"],"PR":["Curitiba","Londrina"],
  "PE":["Recife"],"PI":["Teresina"],"RJ":["Rio de Janeiro","Niter√≥i"],
  "RN":["Natal"],"RS":["Porto Alegre","Caxias do Sul"],
  "RO":["Porto Velho"],"RR":["Boa Vista"],
  "SC":["Florian√≥polis","Joinville"],
  "SP":["S√£o Paulo","Campinas","Santos","Sorocaba"],
  "SE":["Aracaju"],"TO":["Palmas"]
};

const SOUND_URLS = {
  gavel:"https://cdn.pixabay.com/download/audio/2022/03/15/audio_b8e7f6b3a0.mp3?filename=judge-gavel-182004.mp3",
  murmur:"https://cdn.pixabay.com/download/audio/2021/09/16/audio_7b4b2d7f6c.mp3?filename=crowd-murmur-ambient-75537.mp3"
};

function useSound(url, enabled=true, volume=0.6){
  const ref = useRef(null);
  useEffect(()=>{
    const a = new Audio(url);
    a.volume = volume;
    ref.current = a;
    return ()=>{a.pause();ref.current=null;};
  },[url]);
  const play = ()=>{ if(enabled && ref.current){ref.current.currentTime=0;ref.current.play();} };
  return {play};
}

/* ===================== SEED DE CASOS ===================== */

function seedCases(){
  const casos = [];
  let idSeq = 1;

  function addLote(tipo,baseTitulo,baseResumo,culpado,qtde){
    for(let i=1;i<=qtde;i++){
      casos.push({
        id:`${tipo}-${idSeq++}`,
        tipo,
        titulo:`${baseTitulo} #${i}`,
        resumo:baseResumo,
        gabarito:{culpado},
        status:"na_fila",
        provas:[
          {id:"E1",tipo:"bo",titulo:"Boletim de ocorr√™ncia",conteudo:"Registro oficial do fato com identifica√ß√£o das partes, local, data e din√¢mica resumida."},
          {id:"E2",tipo:"laudo",titulo:"Laudo pericial",conteudo:"An√°lise t√©cnica de vest√≠gios materiais, com descri√ß√£o de les√µes, danos ou circunst√¢ncias objetivas."},
          {id:"E3",tipo:"pericia",titulo:"Per√≠cia complementar",conteudo:"Relat√≥rio complementar com cruzamento de imagens, depoimentos e dados periciais."}
        ]
      });
    }
  }

  // 100 casos criminais
  addLote("criminal",
    "Homic√≠dio simples em briga de bar",
    "Discuss√£o em estabelecimento que evolui para agress√µes f√≠sicas e resultado morte, com controv√©rsia sobre leg√≠tima defesa.",
    true,50);
  addLote("criminal",
    "Roubo em via p√∫blica com arma simulada",
    "Subtra√ß√£o de bens com grave amea√ßa, arma aparentemente verdadeira e reconhecimento da autoria em ju√≠zo.",
    true,50);

  // 100 fam√≠lia
  addLote("familia",
    "Revis√£o de alimentos",
    "Pedido de adequa√ß√£o do valor da pens√£o aliment√≠cia em raz√£o de mudan√ßa econ√¥mica das partes.",
    false,50);
  addLote("familia",
    "Guarda compartilhada e regime de conviv√™ncia",
    "Defini√ß√£o de resid√™ncia de refer√™ncia da crian√ßa e calend√°rio de conviv√™ncia com o outro genitor.",
    false,50);

  // 100 trabalhista
  addLote("trabalhista",
    "Horas extras habituais",
    "Trabalhador alega presta√ß√£o habitual de horas extras sem o devido pagamento ou compensa√ß√£o.",
    false,50);
  addLote("trabalhista",
    "V√≠nculo de emprego disfar√ßado como PJ",
    "Discuss√£o sobre subordina√ß√£o, pessoalidade, habitualidade e onerosidade em contrato formalmente de presta√ß√£o de servi√ßos.",
    false,50);

  // Casos STJ (recurso)
  function addSTJ(titulo,resumo,culpado,qtde){
    for(let i=1;i<=qtde;i++){
      casos.push({
        id:`stj-${idSeq++}`,
        tipo:"stj",
        titulo:`${titulo} #${i}`,
        resumo,
        gabarito:{culpado},
        status:"na_fila",
        provas:[
          {id:"R1",tipo:"doc",titulo:"Ac√≥rd√£o recorrido",conteudo:"Trecho principal do ac√≥rd√£o recorrido com fundamenta√ß√£o jur√≠dica questionada."},
          {id:"R2",tipo:"doc",titulo:"Pe√ßa recursal",conteudo:"Argumentos centrais da parte recorrente acerca de viola√ß√£o de lei federal."}
        ]
      });
    }
  }

  addSTJ("Recurso especial em mat√©ria penal",
    "Discuss√£o sobre dosimetria da pena e interpreta√ß√£o de dispositivo de lei federal.",
    true,15);
  addSTJ("Recurso especial em mat√©ria de fam√≠lia",
    "Controv√©rsia sobre fixa√ß√£o de alimentos √† luz da legisla√ß√£o federal.",
    false,15);

  return casos;
}

/* ===================== IA SIMULADA ===================== */

function extrairPalavrasChave(txt){
  return txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .split(/[^a-z0-9]+/).filter(Boolean);
}

async function iaFala(agente,caso,pergunta=""){
  const chaves = extrairPalavrasChave(pergunta);
  const resumo = caso.resumo;
  let focoExtra = "";

  if(chaves.includes("testemunha")||chaves.includes("versao")||chaves.includes("contradicao")){
    focoExtra = " As partes comentam especificamente sobre a coer√™ncia e eventuais contradi√ß√µes dos depoimentos das testemunhas.";
  }else if(chaves.includes("laudo")||chaves.includes("pericia")){
    focoExtra = " O debate volta-se aos aspectos t√©cnicos do laudo pericial e √† solidez cient√≠fica das conclus√µes.";
  }else if(chaves.includes("alimento")||chaves.includes("pensao")||chaves.includes("guarda")){
    focoExtra = " A discuss√£o enfatiza o melhor interesse da crian√ßa e o equil√≠brio entre as possibilidades e necessidades.";
  }else if(chaves.includes("horas")||chaves.includes("jornada")||chaves.includes("vinculo")){
    focoExtra = " As falas concentram-se nos elementos f√°ticos da rela√ß√£o de trabalho, como subordina√ß√£o e habitualidade.";
  }else if(chaves.includes("recurso")||chaves.includes("acordao")||chaves.includes("lei federal")){
    focoExtra = " No STJ, o foco recai na correta interpreta√ß√£o da lei federal e na uniformiza√ß√£o da jurisprud√™ncia.";
  }

  let prefixo = "";
  let base = "";

  if(agente==="acusacao"){
    prefixo = "ACUSA√á√ÉO ‚Äî ";
    base = "sustenta que o conjunto probat√≥rio, analisado em sua globalidade, √© suficiente para responsabilizar o r√©u, observando o padr√£o de prova exigido na legisla√ß√£o.";
  }else if(agente==="defesa"){
    prefixo = "DEFESA ‚Äî ";
    base = "salienta lacunas, contradi√ß√µes e interpreta√ß√µes alternativas das provas, insistindo na aplica√ß√£o do princ√≠pio da d√∫vida razo√°vel em favor do acusado.";
  }else{
    prefixo = "TESTEMUNHA ‚Äî ";
    base = "relata o que presenciou com riqueza de detalhes, reconhecendo os limites de sua mem√≥ria e percep√ß√£o, sem emitir ju√≠zo jur√≠dico definitivo.";
  }

  const partePergunta = pergunta
    ? `Em resposta √† pergunta do Juiz: "${pergunta}", `
    : "";

  const texto = `${prefixo}${partePergunta}${base}${focoExtra} Resumo do caso: ${resumo}`;

  await new Promise(r=>setTimeout(r,300));
  return texto;
}

/* ===================== COMPONENTES VISUAIS ===================== */

function TypewriterText({text,speed=15}){
  const [shown,setShown] = useState("");
  useEffect(()=>{
    let i=0;
    setShown("");
    const id = setInterval(()=>{
      i++;
      setShown(text.slice(0,i));
      if(i>=text.length) clearInterval(id);
    },speed);
    return ()=>clearInterval(id);
  },[text,speed]);
  return <span>{shown}</span>;
}

/* ---------- Splash ---------- */
function SplashScreen({onStart}){
  return (
    <div className="min-h-screen flex items-center justify-center bg-black">
      <div className="relative w-full max-w-md h-[520px] rounded-3xl overflow-hidden shadow-2xl">
        <div
          className="absolute inset-0"
          style={{backgroundImage:"url('capa.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
        ></div>
        <div className="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-transparent"></div>
        <div className="relative z-10 h-full flex flex-col items-center justify-end pb-10 px-6 text-center">
          <h1 className="text-3xl font-bold mb-1 drop-shadow-lg">Tribunal</h1>
          <p className="text-xl font-semibold mb-3 drop-shadow-lg">Simulador de Juiz</p>
          <p className="text-xs opacity-90 mb-4">Vale Produ√ß√£o ‚Ä¢ Vers√£o 6.0 (prot√≥tipo educacional)</p>
          <button
            onClick={onStart}
            className="px-6 py-3 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold shadow-xl"
          >
            Iniciar
          </button>
        </div>
      </div>
    </div>
  );
}

/* ---------- Tutorial de salvamento ---------- */
function TutorialSalvamento({onContinuar}){
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-slate-950 via-slate-900 to-black text-white">
      <div className="max-w-xl w-full mx-4 p-6 rounded-3xl bg-white/5 border border-white/10 backdrop-blur">
        <h2 className="text-2xl font-bold mb-3">Como o jogo salva seu progresso</h2>
        <ol className="list-decimal pl-5 space-y-2 text-sm">
          <li>Seu avan√ßo √© salvo automaticamente no navegador (localStorage) a cada julgamento conclu√≠do.</li>
          <li>Na tela de login voc√™ pode <b>exportar</b> um arquivo (.json) com todos os perfis.</li>
          <li>Em outro computador ou celular, use o bot√£o <b>Importar save</b> para continuar exatamente de onde parou.</li>
        </ol>
        <p className="mt-4 text-xs opacity-80">
          Dica: use sempre o mesmo nome de usu√°rio (por exemplo: <b>DraMaria</b>) para manter sua carreira organizada.
        </p>
        <button
          onClick={onContinuar}
          className="mt-5 px-5 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Entendi, ir para o login
        </button>
      </div>
    </div>
  );
}

/* ---------- Login ---------- */
function LoginScreen({profiles,setProfiles,currentProfile,setCurrentProfile,onEnter}){
  const [user,setUser] = useState(currentProfile||"");
  const [file,setFile] = useState(null);

  function handleEnter(){
    if(!user.trim()) return;
    const nome = user.trim();
    let updated = {...profiles};
    if(!updated[nome]){
      updated[nome] = {
        nome,
        avatar:null,
        court:null,
        estado:"SP",
        cidade:"S√£o Paulo",
        stats:{julgados:0,acertos:0,prestigio:0,criminal:0,familia:0,trabalhista:0,stj:0},
        historico:[]
      };
    }
    setProfiles(updated);
    localStorage.setItem("juiz_profiles_v6",JSON.stringify(updated));
    setCurrentProfile(nome);
    onEnter();
  }

  function handleExport(){
    const blob = new Blob([JSON.stringify(profiles,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="jogo-do-juiz-save.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function handleImport(){
    if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const data=JSON.parse(e.target.result);
        setProfiles(data);
        localStorage.setItem("juiz_profiles_v6",JSON.stringify(data));
        alert("Save importado com sucesso!");
      }catch(err){
        alert("Arquivo inv√°lido.");
      }
    };
    reader.readAsText(file);
  }

  return (
    <div
      className="min-h-screen flex items-center justify-center"
      style={{backgroundImage:"url('capa.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="bg-black/80 text-white max-w-lg w-full mx-4 p-6 rounded-3xl border border-white/10 backdrop-blur">
        <h1 className="text-sm font-semibold mb-1 text-center">Vale Produ√ß√£o apresenta</h1>
        <h2 className="text-3xl font-bold text-center mb-4">Jogo do Juiz</h2>
        <p className="text-xs text-center mb-4 opacity-80">
          Crie seu usu√°rio ou escolha um perfil j√° existente. Exporte/importe o save quando quiser.
        </p>

        <div className="space-y-3">
          <div>
            <label className="text-xs opacity-80">Usu√°rio</label>
            <input
              className="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 outline-none text-sm"
              value={user}
              onChange={e=>setUser(e.target.value)}
              placeholder="Ex.: DraMaria, EstudanteJo√£o..."
            />
          </div>
          <div className="flex gap-2">
            <button
              onClick={handleEnter}
              className="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Entrar / Criar perfil
            </button>
            <button
              onClick={handleExport}
              className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
            >
              Exportar save
            </button>
          </div>
          <div className="mt-2 text-xs">
            <div className="mb-1">Importar save:</div>
            <input
              type="file"
              accept=".json"
              onChange={e=>setFile(e.target.files[0]||null)}
              className="text-xs"
            />
            <button
              onClick={handleImport}
              className="ml-2 px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs"
            >
              Importar
            </button>
          </div>
        </div>

        {Object.keys(profiles).length>0 && (
          <div className="mt-4">
            <div className="text-xs mb-1 opacity-70">Perfis encontrados:</div>
            <div className="flex flex-wrap gap-2">
              {Object.keys(profiles).map(p=>(
                <button
                  key={p}
                  onClick={()=>setUser(p)}
                  className="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 text-xs"
                >
                  {p}
                </button>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* ---------- Escolha de avatar do jogador ---------- */
function AvatarSelect({profile,onChoose}){
  const avatars=[1,2,3,4,5,6].map(i=>`avatar${i}.jpg`);
  const [sel,setSel]=useState(profile.avatar||avatars[0]);
  return (
    <div className="min-h-screen bg-black flex items-center justify-center text-white">
      <div className="bg-white/5 border border-white/10 rounded-3xl max-w-xl w-full mx-4 p-6">
        <h2 className="text-2xl font-bold mb-4 text-center">Escolha seu avatar</h2>
        <p className="text-xs opacity-80 mb-4 text-center">
          Este ser√° o rosto do seu juiz nas telas de escrit√≥rio, julgamento e relat√≥rios.
        </p>
        <div className="grid grid-cols-3 gap-3 mb-4">
          {avatars.map(a=>(
            <button
              key={a}
              onClick={()=>setSel(a)}
              className={"rounded-2xl overflow-hidden border-2 "+(sel===a?"border-emerald-400":"border-transparent")}
            >
              <img src={a} alt={a} className="w-full h-24 object-cover"/>
            </button>
          ))}
        </div>
        <button
          onClick={()=>onChoose(sel)}
          className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Confirmar avatar
        </button>
      </div>
    </div>
  );
}

/* ---------- Escolha de Tribunal ---------- */
function CourtSelectScreen({onSelectCourt,profile}){
  const courts=[
    {id:"criminal",icon:"‚öñÔ∏è",nome:"Criminal",desc:"Crimes contra a pessoa e o patrim√¥nio. Possui j√∫ri popular."},
    {id:"familia",icon:"üë®‚Äçüë©‚Äçüëß",nome:"Fam√≠lia",desc:"Guarda, pens√£o, div√≥rcio e medidas protetivas. Sem j√∫ri."},
    {id:"trabalhista",icon:"üíº",nome:"Trabalhista",desc:"V√≠nculo, jornada, verbas e danos morais. Sem j√∫ri."}
  ];
  return (
    <div className="min-h-screen bg-black flex items-center justify-center text-white">
      <div className="max-w-4xl w-full mx-4 p-6">
        <h2 className="text-3xl font-bold mb-6 text-center">
          Bem-vindo(a), {profile.nome}. Escolha seu tribunal inicial.
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {courts.map(c=>(
            <button
              key={c.id}
              onClick={()=>onSelectCourt(c.id)}
              className="p-5 rounded-3xl bg-white/10 border border-white/15 hover:bg-white/20 transition text-left"
            >
              <div className="text-3xl mb-2">{c.icon}</div>
              <div className="text-lg font-semibold">{c.nome}</div>
              <p className="text-xs opacity-80 mt-1">{c.desc}</p>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

/* ---------- Escolha de Comarca ---------- */
function LocationSelect({profile,onSelectLocation}){
  const [estado,setEstado]=useState(profile.estado||"SP");
  const cidades=ESTADOS[estado]||[];
  const [cidade,setCidade]=useState(profile.cidade||cidades[0]||"");
  return (
    <div className="min-h-screen bg-black text-white flex items-center justify-center">
      <div className="bg-white/10 p-6 rounded-3xl max-w-md w-full mx-4 border border-white/10">
        <h2 className="text-2xl font-bold mb-4">Escolha a comarca</h2>
        <div className="mb-3">
          <label className="text-xs opacity-80">Estado</label>
          <select
            value={estado}
            onChange={e=>{
              const uf=e.target.value;
              setEstado(uf);
              const lista=ESTADOS[uf]||[];
              setCidade(lista[0]||"");
            }}
            className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
          >
            {Object.keys(ESTADOS).map(uf=>(
              <option key={uf} value={uf}>{uf}</option>
            ))}
          </select>
        </div>
        <div className="mb-4">
          <label className="text-xs opacity-80">Cidade</label>
          <select
            value={cidade}
            onChange={e=>setCidade(e.target.value)}
            className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
          >
            {(ESTADOS[estado]||[]).map(c=>(
              <option key={c} value={c}>{c}</option>
            ))}
          </select>
        </div>
        <button
          onClick={()=>onSelectLocation(estado,cidade)}
          className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Confirmar
        </button>
      </div>
    </div>
  );
}

/* ---------- Viewer de Provas ---------- */
function ProvaViewer({prova,onClose}){
  if(!prova) return null;
  let img=null;
  if(prova.tipo==="bo") img="bo.jpg";
  else if(prova.tipo==="laudo") img="laudo.jpg";
  else if(prova.tipo==="pericia") img="pericia.jpg";
  return (
    <div className="fixed inset-0 bg-black/75 flex items-center justify-center z-40">
      <div className="bg-slate-900 border border-white/15 rounded-3xl max-w-lg w-full mx-4 p-6">
        <h3 className="text-lg font-semibold mb-2">{prova.titulo}</h3>
        {img && (
          <div className="mb-3 rounded-2xl overflow-hidden border border-white/10">
            <img src={img} alt={prova.titulo} className="w-full h-40 object-cover"/>
          </div>
        )}
        <p className="text-sm whitespace-pre-wrap opacity-90 mb-4">{prova.conteudo}</p>
        <button
          onClick={onClose}
          className="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-sm font-semibold"
        >
          Fechar
        </button>
      </div>
    </div>
  );
}

/* ---------- Relat√≥rio semestral ---------- */
function RelatorioSemestral({profile,onClose}){
  const s=profile.stats||{};
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-40 text-white">
      <div className="bg-slate-900 border border-white/15 rounded-3xl max-w-xl w-full mx-4 p-6">
        <div className="flex items-center gap-3 mb-4">
          {profile.avatar && (
            <img src={profile.avatar} alt="avatar" className="w-12 h-12 rounded-full object-cover border border-white/20"/>
          )}
          <div>
            <h3 className="text-lg font-semibold">Relat√≥rio semestral</h3>
            <p className="text-xs opacity-80">{profile.nome} ‚Äî {profile.cidade}/{profile.estado}</p>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-3 text-xs mb-4">
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-[10px] opacity-70 mb-1">Casos julgados</div>
            <div className="text-xl font-bold">{s.julgados||0}</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-[10px] opacity-70 mb-1">√çndice de acertos</div>
            <div className="text-xl font-bold">
              {s.julgados?Math.round((s.acertos||0)*100/(s.julgados||1)):0}%
            </div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-[10px] opacity-70 mb-1">Prest√≠gio</div>
            <div className="text-xl font-bold">{s.prestigio||0}</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-[10px] opacity-70 mb-1">√Åreas trabalhadas</div>
            <div className="text-xs">
              Criminal: {s.criminal||0}<br/>
              Fam√≠lia: {s.familia||0}<br/>
              Trab.: {s.trabalhista||0}<br/>
              STJ: {s.stj||0}
            </div>
          </div>
        </div>
        <p className="text-xs mb-4 opacity-80">
          Parecer geral: {s.julgados>0
            ? s.acertos/s.julgados>=0.7
              ? "Desempenho consistente, com boa taxa de acertos e dom√≠nio crescente das provas."
              : "√â recomend√°vel revisar fundamentos jur√≠dicos e an√°lise de prova para elevar a taxa de acerto."
            : "Ainda n√£o h√° casos suficientes para avalia√ß√£o. Julgue alguns processos para gerar dados."}
        </p>
        <button
          onClick={onClose}
          className="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold w-full"
        >
          Fechar relat√≥rio
        </button>
      </div>
    </div>
  );
}

/* ---------- Exame STJ ---------- */
function STJExam({onFinish}){
  const banco=[];
  for(let i=1;i<=50;i++){
    banco.push({
      id:i,
      enunciado:`Quest√£o ${i}: Em um recurso especial ao STJ, qual √© o foco principal da an√°lise em mat√©ria de lei federal?`,
      opcoes:[
        "Reexame amplo de fatos e provas produzidos na origem.",
        "Interpreta√ß√£o e aplica√ß√£o da legisla√ß√£o federal infraconstitucional.",
        "Controle de constitucionalidade concentrado das leis estaduais.",
        "Fixa√ß√£o do valor da causa para fins de custas."
      ],
      correta:1
    });
  }
  const selecionadas=[];
  const used=new Set();
  while(selecionadas.length<10){
    const idx=Math.floor(Math.random()*banco.length);
    if(!used.has(idx)){used.add(idx);selecionadas.push(banco[idx]);}
  }
  const [respostas,setRespostas]=useState({});
  const [finalizado,setFinalizado]=useState(false);
  const [nota,setNota]=useState(0);

  function corrigir(){
    let ac=0;
    selecionadas.forEach(q=>{
      if(respostas[q.id]===q.correta) ac++;
    });
    const perc=Math.round(ac*100/selecionadas.length);
    setNota(perc);
    setFinalizado(true);
    const aprovado=perc>=70;
    onFinish(aprovado,perc);
  }

  return (
    <div
      className="min-h-screen flex items-center justify-center text-white"
      style={{backgroundImage:"url('stj.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="bg-black/80 border border-white/10 rounded-3xl max-w-3xl w-full mx-4 p-6 max-h-[90vh] overflow-y-auto scroll-thin">
        <h2 className="text-2xl font-bold mb-2 text-center">Prova simulada para ingresso no STJ</h2>
        <p className="text-xs opacity-80 mb-4 text-center">
          Responda 10 quest√µes objetivas. √â necess√°rio atingir pelo menos 70% de acertos.
        </p>
        {selecionadas.map(q=>(
          <div key={q.id} className="mb-4">
            <div className="text-sm font-semibold mb-1">{q.enunciado}</div>
            <div className="space-y-1 text-xs">
              {q.opcoes.map((op,i)=>(
                <label key={i} className="flex items-start gap-2 cursor-pointer">
                  <input
                    type="radio"
                    name={`q${q.id}`}
                    checked={respostas[q.id]===i}
                    onChange={()=>setRespostas(r=>({...r,[q.id]:i}))}
                  />
                  <span>{op}</span>
                </label>
              ))}
            </div>
          </div>
        ))}
        <button
          onClick={corrigir}
          className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold mt-2"
        >
          Corrigir prova
        </button>
        {finalizado && (
          <p className="mt-3 text-xs text-center">
            Nota: {nota}%. {nota>=70 ? "Parab√©ns! Voc√™ est√° apto a atuar no STJ." : "Ainda n√£o atingiu a nota m√≠nima. Continue estudando e tente novamente."}
          </p>
        )}
      </div>
    </div>
  );
}

/* ---------- Escrit√≥rio ---------- */
function Escritorio({profile,cases,onSelectCase,onSTJ,onRelatorio,sons}){
  const fila=cases.filter(c=>c.status==="na_fila" && (profile.court==="stj"?c.tipo==="stj":c.tipo===profile.court));
  const s=profile.stats||{};
  return (
    <div
      className="min-h-screen relative text-white"
      style={{backgroundImage:"url('escritorio.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
      <div className="relative z-10 max-w-6xl mx-auto p-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            {profile.avatar && (
              <img src={profile.avatar} alt="avatar" className="w-12 h-12 rounded-full object-cover border border-white/20"/>
            )}
            <div>
              <h1 className="text-2xl font-bold">Escrit√≥rio do Juiz</h1>
              <p className="text-xs opacity-80">
                {profile.nome} ‚Äî {profile.cidade}/{profile.estado} ‚Ä¢ {profile.court==="stj"?"Ministro do STJ":(profile.court||"sem tribunal")}
              </p>
            </div>
          </div>
          <div className="text-xs text-right opacity-80">
            Julgados: {s.julgados||0}<br/>
            Acertos: {s.acertos||0}<br/>
            Prest√≠gio: {s.prestigio||0}
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-white/10 border border-white/10 rounded-3xl p-5">
            <h2 className="text-lg font-semibold mb-3">Fila de processos</h2>
            <div className="max-h-96 overflow-y-auto space-y-3 pr-2 scroll-thin">
              {fila.length===0 && (
                <p className="text-xs opacity-70">Nenhum processo na fila para este tribunal.</p>
              )}
              {fila.map(c=>(
                <div key={c.id} className="p-3 rounded-2xl bg-white/5 border border-white/10">
                  <h3 className="text-sm font-semibold mb-1">{c.titulo}</h3>
                  <p className="text-xs opacity-80 mb-2">{c.resumo}</p>
                  <button
                    onClick={()=>{sons.gavel.play();onSelectCase(c.id);}}
                    className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                  >
                    Iniciar julgamento
                  </button>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white/10 border border-white/10 rounded-3xl p-5 flex flex-col">
            <h2 className="text-lg font-semibold mb-3">Painel da carreira</h2>
            <p className="text-xs opacity-80 mb-3">
              Acompanhe sua evolu√ß√£o, acesse relat√≥rios e, quando estiver pronto, candidate-se ao STJ.
            </p>
            <button
              onClick={onRelatorio}
              className="mb-2 w-full px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm font-semibold"
            >
              Ver relat√≥rio semestral
            </button>
            <button
              onClick={onSTJ}
              className="w-full px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-sm font-semibold mt-2"
            >
              Candidatar-se ao STJ
            </button>
            <div className="mt-4 text-[10px] opacity-70">
              Simula√ß√£o educacional inspirada em rotinas reais, sem valor jur√≠dico. Para uso em escolas, cursos e treinamentos.
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ---------- Julgamento ---------- */
function Julgamento({caso,onVoltar,onFinish,profile,sons}){
  const [falas,setFalas]=useState([]);
  const [pergunta,setPergunta]=useState("");
  const [provaSel,setProvaSel]=useState(null);
  const [jurados,setJurados]=useState([]);
  const [deliberou,setDeliberou]=useState(false);

  useEffect(()=>{
    const inicial=[];
    for(let i=1;i<=12;i++){
      inicial.push({id:i,avatar:`juri${i}.jpg`,voto:null});
    }
    setJurados(inicial);
    setFalas([]);
    setPergunta("");
    setDeliberou=false;
  },[caso.id]);

  async function ouvir(ag){
    const fala = await iaFala(ag,caso,"");
    setFalas(f=>[...f,{autor:ag,texto:fala}]);
    sons.murmur.play();
  }

  async function perguntarIA(){
    if(!pergunta.trim()) return;
    const fala = await iaFala("testemunha",caso,pergunta);
    setFalas(f=>[
      ...f,
      {autor:"juiz",texto:"Pergunta do Juiz: "+pergunta},
      {autor:"testemunha",texto:fala}
    ]);
    setPergunta("");
    sons.murmur.play();
  }

  function decidir(veredito){
    const acertou=veredito===caso.gabarito.culpado;
    onFinish(caso,veredito,acertou);
  }

  function iniciarDeliberacao(){
    if(caso.tipo!=="criminal"){
      alert("Para este tipo de caso (Fam√≠lia, Trabalhista ou STJ) n√£o h√° j√∫ri popular. A decis√£o √© exclusiva do Juiz.");
      return;
    }
    if(deliberou) return;
    const novo=jurados.map(j=>{
      const tendencia=caso.gabarito.culpado?0.7:0.3;
      const r=Math.random();
      const voto = r<tendencia;
      return {...j,voto};
    });
    setJurados(novo);
    setDeliberou(true);
  }

  return (
    <div
      className="min-h-screen relative text-white"
      style={{backgroundImage:"url('saladejulgamento.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="absolute inset-0 bg-black/75 backdrop-blur-sm"></div>
      <ProvaViewer prova={provaSel} onClose={()=>setProvaSel(null)}/>
      <div className="relative z-10 max-w-5xl mx-auto p-6">
        <div className="flex items-center justify-between mb-3">
          <button
            onClick={onVoltar}
            className="px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
          >
            Voltar ao escrit√≥rio
          </button>
          {profile.avatar && (
            <img src={profile.avatar} alt="avatar" className="w-10 h-10 rounded-full border border-white/30 object-cover"/>
          )}
        </div>

        <h1 className="text-2xl font-bold mb-1">Sala de Julgamento</h1>
        <p className="text-xs opacity-80 mb-4">{caso.titulo}</p>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2">
            <div className="mb-3 space-x-2">
              <button
                onClick={()=>ouvir("acusacao")}
                className="px-3 py-1 rounded-xl bg-red-500 hover:bg-red-600 text-xs"
              >
                Ouvir Acusa√ß√£o
              </button>
              <button
                onClick={()=>ouvir("defesa")}
                className="px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs"
              >
                Ouvir Defesa
              </button>
              <button
                onClick={()=>ouvir("testemunha")}
                className="px-3 py-1 rounded-xl bg-amber-500 hover:bg-amber-600 text-xs"
              >
                Ouvir Testemunha
              </button>
            </div>

            <div className="bg-white/5 rounded-3xl border border-white/10 p-4 max-h-72 overflow-y-auto scroll-thin mb-3">
              {falas.length===0 && (
                <p className="text-xs opacity-70">
                  Use os bot√µes acima para ouvir a acusa√ß√£o, a defesa ou uma testemunha. As falas aparecem aqui com efeito de m√°quina de escrever.
                </p>
              )}
              {falas.map((f,i)=>(
                <div key={i} className="mb-3 flex gap-2">
                  {f.autor==="acusacao" && (
                    <img src="promotor.jpg" alt="promotor" className="w-8 h-8 rounded-full object-cover mt-1"/>
                  )}
                  {f.autor==="defesa" && (
                    <img src="advogado.jpg" alt="advogado" className="w-8 h-8 rounded-full object-cover mt-1"/>
                  )}
                  {f.autor==="testemunha" && (
                    <img src="testemunha.jpg" alt="testemunha" className="w-8 h-8 rounded-full object-cover mt-1"/>
                  )}
                  {f.autor==="juiz" && (
                    <img src={profile.avatar} alt="juiz" className="w-8 h-8 rounded-full object-cover mt-1"/>
                  )}
                  <div className="text-xs bg-black/40 rounded-2xl px-3 py-2 flex-1">
                    <TypewriterText text={f.texto}/>
                  </div>
                </div>
              ))}
            </div>

            <div className="flex gap-2 mb-3">
              <input
                className="flex-1 px-3 py-2 rounded-2xl bg-white/10 text-xs outline-none"
                placeholder="Pergunta do Juiz (ex.: Testemunha, explique a contradi√ß√£o do depoimento)..."
                value={pergunta}
                onChange={e=>setPergunta(e.target.value)}
                onKeyDown={e=>{if(e.key==="Enter") perguntarIA();}}
              />
              <button
                onClick={perguntarIA}
                className="px-3 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
              >
                Perguntar
              </button>
            </div>

            <div className="flex gap-2 mb-2">
              <button
                onClick={()=>decidir(true)}
                className="px-3 py-2 rounded-2xl bg-red-600 hover:bg-red-700 text-xs font-semibold"
              >
                Condenar
              </button>
              <button
                onClick={()=>decidir(false)}
                className="px-3 py-2 rounded-2xl bg-sky-600 hover:bg-sky-700 text-xs font-semibold"
              >
                Absolver
              </button>
            </div>
          </div>

          <div>
            <div className="bg-white/5 rounded-3xl border border-white/10 p-4 mb-4">
              <h3 className="text-sm font-semibold mb-2">Dossi√™ (Provas)</h3>
              <ul className="text-xs space-y-1">
                {caso.provas.map(p=>(
                  <li key={p.id}>
                    <button
                      onClick={()=>setProvaSel(p)}
                      className="underline hover:text-emerald-300"
                    >
                      [{p.id}] {p.titulo}
                    </button>
                  </li>
                ))}
              </ul>
            </div>

            <div className="bg-white/5 rounded-3xl border border-white/10 p-4">
              <h3 className="text-sm font-semibold mb-2">J√∫ri Popular (12)</h3>
              {caso.tipo!=="criminal" && (
                <p className="text-[11px] opacity-80 mb-2">
                  Para este tipo de a√ß√£o n√£o h√° j√∫ri popular. Clique em <b>Iniciar Delibera√ß√£o</b> para ver uma mensagem educativa.
                </p>
              )}
              {caso.tipo==="criminal" && (
                <div className="grid grid-cols-4 gap-2 mb-2">
                  {jurados.map(j=>(
                    <div key={j.id} className="flex flex-col items-center text-[10px]">
                      <img src={j.avatar} alt={"Jur"+j.id} className="w-8 h-8 rounded-full object-cover border border-white/30 mb-1"/>
                      <div className="opacity-70">J{j.id}</div>
                      {j.voto!==null && (
                        <div className={"mt-1 px-1 rounded-full "+(j.voto?"bg-red-600":"bg-sky-600")}>
                          {j.voto?"C":"A"}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
              <button
                onClick={iniciarDeliberacao}
                className="w-full mt-1 px-3 py-2 rounded-2xl bg-amber-500 hover:bg-amber-600 text-[11px] font-semibold"
              >
                Iniciar Delibera√ß√£o
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ===================== APP PRINCIPAL ===================== */

function App(){
  const [view,setView]=useState("splash");
  const [profiles,setProfiles]=useState({});
  const [currentProfile,setCurrentProfile]=useState(null);
  const [cases,setCases]=useState(seedCases);
  const [currentCase,setCurrentCase]=useState(null);
  const [stjMode,setStjMode]=useState(false);

  const gavelSound=useSound(SOUND_URLS.gavel,true);
  const murmurSound=useSound(SOUND_URLS.murmur,true);
  const sons={gavel:gavelSound,murmur:murmurSound};

  useEffect(()=>{
    try{
      const saved=JSON.parse(localStorage.getItem("juiz_profiles_v6")||"{}");
      const curr=localStorage.getItem("juiz_current_v6")||null;
      setProfiles(saved);
      setCurrentProfile(curr);
    }catch(e){}
  },[]);

  useEffect(()=>{
    if(currentProfile){
      localStorage.setItem("juiz_current_v6",currentProfile);
    }
  },[currentProfile]);

  function updateProfile(updater){
    setProfiles(prev=>{
      const p={...prev};
      const curr=p[currentProfile];
      if(!curr) return prev;
      const novo=updater(curr);
      p[currentProfile]=novo;
      localStorage.setItem("juiz_profiles_v6",JSON.stringify(p));
      return p;
    });
  }

  const profile=currentProfile?profiles[currentProfile]:null;

  function handleFinishCase(caso,veredito,acertou){
    setCases(prev=>prev.map(c=>c.id===caso.id?{...c,status:veredito?"condenado":"absolvido"}:c));
    updateProfile(p=>{
      const stats={...(p.stats||{})};
      stats.julgados=(stats.julgados||0)+1;
      if(acertou) stats.acertos=(stats.acertos||0)+1;
      const delta=acertou?3:-1;
      stats.prestigio=Math.max(0,(stats.prestigio||0)+delta);
      stats[caso.tipo]=(stats[caso.tipo]||0)+1;
      const hist=[...(p.historico||[])];
      hist.push({
        id:caso.id,
        titulo:caso.titulo,
        tipo:caso.tipo,
        veredito,
        acertou,
        data:new Date().toISOString()
      });
      return {...p,stats,historico:hist};
    });
    alert(acertou?"Decis√£o coerente com o gabarito da simula√ß√£o.":"Nesta simula√ß√£o, o gabarito indicava solu√ß√£o diversa. Veja o relat√≥rio para estudar.");
    setView("escritorio");
  }

  function tentarSTJ(){
    if(!profile) return;
    const s=profile.stats||{};
    if(profile.court==="stj"){
      alert("Voc√™ j√° est√° atuando no STJ.");
      return;
    }
    if(s.julgados<10 || s.prestigio<40 || (s.julgados? (s.acertos||0)*100/s.julgados : 0)<60){
      alert("Para se candidatar ao STJ √© necess√°rio:\n- Pelo menos 10 casos julgados;\n- Prest√≠gio m√≠nimo de 40;\n- Pelo menos 60% de acertos.\nContinue jogando e estudando!");
      return;
    }
    setStjMode(true);
    setView("stjExam");
  }

  function finalizarProvaSTJ(aprovado,nota){
    setStjMode(false);
    if(!aprovado){
      alert("Nota na prova STJ: "+nota+"%. Ainda n√£o foi desta vez. Continue estudando!");
      setView("escritorio");
      return;
    }
    updateProfile(p=>({...p,court:"stj"}));
    alert("Parab√©ns! Voc√™ foi aprovado na prova simulada e agora atua no STJ.");
    setView("escritorio");
  }

  if(view==="splash") return <SplashScreen onStart={()=>setView("tutorial")}/>;
  if(view==="tutorial") return <TutorialSalvamento onContinuar={()=>setView("login")}/>;
  if(view==="login") return (
    <LoginScreen
      profiles={profiles}
      setProfiles={setProfiles}
      currentProfile={currentProfile}
      setCurrentProfile={setCurrentProfile}
      onEnter={()=>{
        const p=profiles[currentProfile]||profiles[Object.keys(profiles)[0]];
        if(p && p.avatar){setView("courtSelect");}
        else setView("avatar");
      }}
    />
  );
  if(!profile) return null;

  if(view==="avatar") return (
    <AvatarSelect
      profile={profile}
      onChoose={avatar=>{
        updateProfile(p=>({...p,avatar}));
        setView("courtSelect");
      }}
    />
  );

  if(view==="courtSelect") return (
    <CourtSelectScreen
      profile={profile}
      onSelectCourt={court=>{
        updateProfile(p=>({...p,court}));
        setView("location");
      }}
    />
  );

  if(view==="location") return (
    <LocationSelect
      profile={profile}
      onSelectLocation={(estado,cidade)=>{
        updateProfile(p=>({...p,estado,cidade}));
        setView("escritorio");
      }}
    />
  );

  if(view==="escritorio") return (
    <Escritorio
      profile={profile}
      cases={cases}
      onSelectCase={id=>{
        const c=cases.find(x=>x.id===id);
        if(c){setCurrentCase(c);setView("julgamento");}
      }}
      onSTJ={tentarSTJ}
      onRelatorio={()=>setView("relatorio")}
      sons={sons}
    />
  );

  if(view==="relatorio") return (
    <>
      <Escritorio
        profile={profile}
        cases={cases}
        onSelectCase={id=>{
          const c=cases.find(x=>x.id===id);
          if(c){setCurrentCase(c);setView("julgamento");}
        }}
        onSTJ={tentarSTJ}
        onRelatorio={()=>{}}
        sons={sons}
      />
      <RelatorioSemestral profile={profile} onClose={()=>setView("escritorio")}/>
    </>
  );

  if(view==="julgamento" && currentCase) return (
    <Julgamento
      caso={currentCase}
      profile={profile}
      sons={sons}
      onVoltar={()=>setView("escritorio")}
      onFinish={handleFinishCase}
    />
  );

  if(view==="stjExam" && stjMode) return <STJExam onFinish={finalizarProvaSTJ}/>;

  return null;
}

/* ===================== RENDER ===================== */

const root=ReactDOM.createRoot(document.getElementById("root"));
root.render(<App/>);
</script>
</body>
</html>
