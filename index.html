<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Jogo do Juiz ‚Äî Vale Produ√ß√£o</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html,body,#root{height:100%;}
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    .scroll-thin::-webkit-scrollbar{width:6px;}
    .scroll-thin::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:999px;}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
const { useState, useEffect, useRef } = React;

/* ========= DADOS FIXOS ========= */

const ESTADOS = {
  "AC":["Rio Branco"],"AL":["Macei√≥"],"AP":["Macap√°"],"AM":["Manaus"],
  "BA":["Salvador","Feira de Santana","Vit√≥ria da Conquista"],
  "CE":["Fortaleza"],"DF":["Bras√≠lia"],"ES":["Vit√≥ria"],"GO":["Goi√¢nia"],
  "MA":["S√£o Lu√≠s"],"MT":["Cuiab√°"],"MS":["Campo Grande"],
  "MG":["Belo Horizonte","Uberl√¢ndia","Juiz de Fora"],
  "PA":["Bel√©m"],"PB":["Jo√£o Pessoa"],"PR":["Curitiba","Londrina"],
  "PE":["Recife"],"PI":["Teresina"],"RJ":["Rio de Janeiro","Niter√≥i"],
  "RN":["Natal"],"RS":["Porto Alegre","Caxias do Sul"],
  "RO":["Porto Velho"],"RR":["Boa Vista"],
  "SC":["Florian√≥polis","Joinville"],
  "SP":["S√£o Paulo","Campinas","Santos","Sorocaba"],
  "SE":["Aracaju"],"TO":["Palmas"]
};

const SOUND_URLS = {
  gavel:"https://cdn.pixabay.com/download/audio/2022/03/15/audio_b8e7f6b3a0.mp3?filename=judge-gavel-182004.mp3",
  murmur:"https://cdn.pixabay.com/download/audio/2021/09/16/audio_7b4b2d7f6c.mp3?filename=crowd-murmur-ambient-75537.mp3"
};

function useSound(url, enabled=true, volume=0.7){
  const ref = useRef(null);
  useEffect(()=>{
    const a = new Audio(url);
    a.volume = volume;
    ref.current = a;
    return ()=>{ a.pause(); ref.current=null; };
  },[url]);
  const play = ()=>{ if(enabled && ref.current){ ref.current.currentTime=0; ref.current.play(); } };
  return { play };
}

/* ========= GERADOR DE CASOS ========= */

function seedCases(){
  const casos=[];
  let id=1;

  function addLote(tipo, modelos){
    modelos.forEach(m=>{
      for(let i=0;i<5;i++){
        const provasBase = [
          {
            id:"E1",
            titulo:"Boletim de ocorr√™ncia",
            tipo:"boletim",
            conteudo:"Registro oficial do fato com hor√°rio, local e identifica√ß√£o das partes."
          },
          {
            id:"E2",
            titulo:"Laudo pericial",
            tipo:"laudo",
            conteudo:"Documento t√©cnico elaborado por perito habilitado, descrevendo danos, circunst√¢ncias e metodologia."
          },
          {
            id:"E3",
            titulo:"Depoimento de testemunha",
            tipo:"testemunha",
            conteudo:"Relato de pessoa que presenciou parte dos acontecimentos, com pontos fortes e fragilidades."
          }
        ];
        casos.push({
          id: tipo+"-"+(id++),
          tipo,
          titulo: m.titulo+" #"+(i+1),
          resumo: m.resumo,
          gabarito: { culpado: m.culpado },
          provas: provasBase,
          status:"na_fila"
        });
      }
    });
  }

  addLote("criminal",[
    {
      titulo:"Homic√≠dio simples em briga de bar",
      resumo:"Discuss√£o em estabelecimento que evolui para agress√µes f√≠sicas graves, culminando em morte de um dos envolvidos.",
      culpado:true
    },
    {
      titulo:"Roubo em via p√∫blica",
      resumo:"Agente aborda v√≠tima em via p√∫blica, subtraindo celular com emprego de amea√ßa mediante simulacro de arma.",
      culpado:true
    },
    {
      titulo:"Les√£o corporal em viol√™ncia dom√©stica",
      resumo:"Conflito entre casal em resid√™ncia, com alega√ß√£o de leg√≠tima defesa e hist√≥rico de agress√µes anteriores.",
      culpado:true
    }
  ]);

  addLote("familia",[
    {
      titulo:"Revis√£o de alimentos",
      resumo:"Genitor requer redu√ß√£o de pens√£o aliment√≠cia em raz√£o de perda de emprego e novo filho em outro relacionamento.",
      culpado:false
    },
    {
      titulo:"Guarda compartilhada",
      resumo:"Pais discutem resid√™ncia principal da crian√ßa e regime de conviv√™ncia, ambos aptos e envolvidos na cria√ß√£o.",
      culpado:false
    },
    {
      titulo:"Regulamenta√ß√£o de visitas com medida protetiva",
      resumo:"Hist√≥rico de conflitos intensos gera medida protetiva; discute-se visitas supervisionadas em espa√ßo neutro.",
      culpado:false
    }
  ]);

  addLote("trabalhista",[
    {
      titulo:"Horas extras habituais",
      resumo:"Empregado alega jornada di√°ria superior √† contratual sem o devido pagamento de horas extras e reflexos.",
      culpado:false
    },
    {
      titulo:"V√≠nculo de emprego X PJ",
      resumo:"Trabalhador contratado como pessoa jur√≠dica afirma subordina√ß√£o, habitualidade, pessoalidade e onerosidade.",
      culpado:false
    },
    {
      titulo:"Ass√©dio moral no ambiente de trabalho",
      resumo:"Supervisor dirige reiteradas humilha√ß√µes em p√∫blico, alegando apenas cobran√ßa por desempenho.",
      culpado:false
    }
  ]);

  return casos;
}

/* ========= IA SIMULADA & TYPEWRITER ========= */

async function iaFala(agente, caso, pergunta=""){
  const resumo = caso.resumo;
  const prefixo =
    agente==="acusacao" ? "ACUSA√á√ÉO ‚Äî " :
    agente==="defesa" ? "DEFESA ‚Äî " :
    "TESTEMUNHA ‚Äî ";

  const foco = pergunta
    ? 'Respondendo √† pergunta do Juiz: "'+pergunta+'". '
    : "Expondo os principais pontos do processo. ";

  const base =
    agente==="acusacao"
      ? "A acusa√ß√£o destaca a coer√™ncia das provas e a gravidade do fato, defendendo a responsabiliza√ß√£o do r√©u nos limites da lei. "
      : agente==="defesa"
        ? "A defesa enfatiza contradi√ß√µes, lacunas probat√≥rias e o princ√≠pio do in dubio pro reo, buscando afastar a condena√ß√£o. "
        : "A testemunha descreve o que viu e ouviu, sem assumir posi√ß√£o jur√≠dica, mas ajudando a reconstruir a din√¢mica dos fatos. ";

  const texto = prefixo + foco + base + "Resumo do caso: " + resumo;
  await new Promise(r=>setTimeout(r,300));
  return texto;
}

function TypewriterText({text,speed=18}){
  const [display,setDisplay]=useState("");
  useEffect(()=>{
    let i=0;
    setDisplay("");
    if(!text) return;
    const id=setInterval(()=>{
      i++;
      setDisplay(text.slice(0,i));
      if(i>=text.length) clearInterval(id);
    },speed);
    return ()=>clearInterval(id);
  },[text,speed]);
  return <span>{display}</span>;
}

/* ========= TELAS ========= */

function SplashScreen({onStart}){
  return (
    <div className="min-h-screen flex items-center justify-center bg-black">
      <div className="relative w-full max-w-md h-[520px] rounded-3xl overflow-hidden shadow-2xl">
        <div className="absolute inset-0 bg-[url('capa.jpg')] bg-cover bg-center" />
        <div className="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-transparent" />
        <div className="relative z-10 h-full flex flex-col items-center justify-end pb-10 px-6">
          <h1 className="text-3xl font-bold mb-1 drop-shadow-lg text-center">Jogo do Juiz</h1>
          <p className="text-sm opacity-90 mb-4 text-center">Vale Produ√ß√£o ‚Ä¢ Simulador Educacional</p>
          <button
            onClick={onStart}
            className="px-6 py-3 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold shadow-xl"
          >
            Iniciar
          </button>
        </div>
      </div>
    </div>
  );
}

function TutorialSalvamento({onContinuar}){
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-slate-950 via-slate-900 to-black text-white">
      <div className="max-w-xl w-full mx-4 p-6 rounded-3xl bg-white/5 border border-white/10 backdrop-blur">
        <h2 className="text-2xl font-bold mb-3">Como o jogo salva seu progresso</h2>
        <ol className="list-decimal pl-5 space-y-2 text-sm">
          <li>Seu progresso fica salvo automaticamente no pr√≥prio navegador (carreira do juiz).</li>
          <li>Voc√™ pode exportar um arquivo de backup pela tela de login.</li>
          <li>Em outro computador ou celular, importe o arquivo para continuar do ponto em que parou.</li>
        </ol>
        <p className="mt-4 text-xs opacity-80">
          Dica: use sempre o mesmo nome de usu√°rio (ex.: <b>DraMaria</b>) para acompanhar sua evolu√ß√£o.
        </p>
        <button
          onClick={onContinuar}
          className="mt-5 px-5 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Entendi, ir para o login
        </button>
      </div>
    </div>
  );
}

function AvatarPicker({avatar,setAvatar}){
  const lista=[1,2,3,4,5,6].map(i=>`avatar${i}.jpg`);
  return (
    <div className="mt-4">
      <div className="text-xs mb-1 opacity-80">Escolha seu avatar de Juiz(a):</div>
      <div className="flex flex-wrap gap-2">
        {lista.map(src=>(
          <button
            key={src}
            type="button"
            onClick={()=>setAvatar(src)}
            className={
              "border rounded-2xl overflow-hidden w-14 h-14 "+(avatar===src?"border-emerald-400 ring-2 ring-emerald-500":"border-white/20")
            }
          >
            <img src={src} className="w-full h-full object-cover" alt={src}/>
          </button>
        ))}
      </div>
    </div>
  );
}

function LoginScreen({profiles,setProfiles,setCurrentProfile,onEnter}){
  const [user,setUser]=useState("");
  const [file,setFile]=useState(null);
  const [avatar,setAvatar]=useState("avatar1.jpg");

  function salvarProfiles(p){
    setProfiles(p);
    localStorage.setItem("juiz_profiles",JSON.stringify(p));
  }

  function handleEnter(){
    if(!user.trim()) return;
    const nome=user.trim();
    const atual = profiles[nome];
    const novoProfile = atual || {
      nome,
      avatar,
      court:null,
      estado:"SP",
      cidade:"S√£o Paulo",
      stats:{julgados:0,acertos:0,prestigio:0}
    };
    if(!atual){
      salvarProfiles({...profiles,[nome]:novoProfile});
    }else if(!atual.avatar){
      salvarProfiles({...profiles,[nome]:{...atual,avatar}});
    }
    setCurrentProfile(nome);
    onEnter();
  }

  function handleExport(){
    const blob = new Blob([JSON.stringify(profiles,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="jogo-do-juiz-save.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function handleImport(){
    if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const data=JSON.parse(e.target.result);
        salvarProfiles(data);
        alert("Save importado com sucesso!");
      }catch(err){
        alert("Arquivo inv√°lido.");
      }
    };
    reader.readAsText(file);
  }

  return (
    <div className="min-h-screen bg-[url('capa.jpg')] bg-cover bg-center flex items-center justify-center">
      <div className="bg-black/80 text-white max-w-lg w-full mx-4 p-6 rounded-3xl border border-white/10 backdrop-blur">
        <h1 className="text-xl font-semibold mb-1 text-center">Vale Produ√ß√£o apresenta</h1>
        <h2 className="text-3xl font-bold text-center mb-4">Jogo do Juiz</h2>
        <p className="text-xs text-center mb-4 opacity-80">
          Crie seu usu√°rio, escolha um avatar e controle sua carreira jur√≠dica.
        </p>

        <div className="space-y-3">
          <div>
            <label className="text-xs opacity-80">Usu√°rio</label>
            <input
              className="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 outline-none text-sm"
              value={user}
              onChange={e=>setUser(e.target.value)}
              placeholder="Ex.: DraMaria, EstudanteJo√£o..."
            />
          </div>

          <AvatarPicker avatar={avatar} setAvatar={setAvatar} />

          <div className="flex gap-2 mt-4">
            <button
              onClick={handleEnter}
              className="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Entrar / Criar perfil
            </button>
            <button
              onClick={handleExport}
              className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
            >
              Exportar save
            </button>
          </div>

          <div className="mt-2 text-xs">
            <div className="mb-1">Importar save:</div>
            <input
              type="file"
              accept=".json"
              onChange={e=>setFile(e.target.files[0]||null)}
              className="text-xs"
            />
            <button
              onClick={handleImport}
              className="ml-2 px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs"
            >
              Importar
            </button>
          </div>
        </div>

        {Object.keys(profiles).length>0 && (
          <div className="mt-4">
            <div className="text-xs mb-1 opacity-70">Perfis existentes:</div>
            <div className="flex flex-wrap gap-2">
              {Object.keys(profiles).map(p=>(
                <button
                  key={p}
                  onClick={()=>{
                    setUser(p);
                    if(profiles[p].avatar) setAvatar(profiles[p].avatar);
                  }}
                  className="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 text-xs"
                >
                  {p}
                </button>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function CourtSelectScreen({onSelectCourt,profile}){
  const courts = [
    {id:"criminal",icon:"‚öñÔ∏è",nome:"Criminal",desc:"Crimes contra a pessoa e o patrim√¥nio."},
    {id:"familia",icon:"üë®‚Äçüë©‚Äçüëß",nome:"Fam√≠lia",desc:"Guarda, pens√£o, div√≥rcio e medidas protetivas."},
    {id:"trabalhista",icon:"üíº",nome:"Trabalhista",desc:"V√≠nculo, jornada, verbas e danos morais."}
  ];
  return (
    <div className="min-h-screen bg-black flex items-center justify-center text-white">
      <div className="max-w-4xl w-full mx-4 p-6">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-3xl font-bold">Escolha o Tribunal</h2>
          {profile.avatar && (
            <img src={profile.avatar} className="w-10 h-10 rounded-full border border-white/30 object-cover" alt="avatar"/>
          )}
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {courts.map(c=>(
            <button
              key={c.id}
              onClick={()=>onSelectCourt(c.id)}
              className="p-5 rounded-3xl bg-white/10 border border-white/15 hover:bg-white/20 transition text-left"
            >
              <div className="text-3xl mb-2">{c.icon}</div>
              <div className="text-lg font-semibold">{c.nome}</div>
              <p className="text-xs opacity-80 mt-1">{c.desc}</p>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

function LocationSelect({profile,onSelectLocation}){
  const [estado,setEstado]=useState(profile.estado||"SP");
  const cidades=ESTADOS[estado]||[];
  const [cidade,setCidade]=useState(profile.cidade||cidades[0]||"");

  return (
    <div className="min-h-screen bg-black text-white flex items-center justify-center">
      <div className="bg-white/10 p-6 rounded-3xl max-w-md w-full mx-4 border border-white/10">
        <h2 className="text-2xl font-bold mb-4">Escolha a comarca</h2>
        <div className="mb-3">
          <label className="text-xs opacity-80">Estado</label>
          <select
            value={estado}
            onChange={e=>{
              const uf=e.target.value;
              setEstado(uf);
              const lista=ESTADOS[uf]||[];
              setCidade(lista[0]||"");
            }}
            className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
          >
            {Object.keys(ESTADOS).map(uf=>(
              <option key={uf} value={uf}>{uf}</option>
            ))}
          </select>
        </div>
        <div className="mb-4">
          <label className="text-xs opacity-80">Cidade</label>
          <select
            value={cidade}
            onChange={e=>setCidade(e.target.value)}
            className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
          >
            {(ESTADOS[estado]||[]).map(c=>(
              <option key={c} value={c}>{c}</option>
            ))}
          </select>
        </div>
        <button
          onClick={()=>onSelectLocation(estado,cidade)}
          className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Confirmar
        </button>
      </div>
    </div>
  );
}

function ProvaViewer({prova,onClose}){
  if(!prova) return null;
  let bg="bo.jpg";
  if(prova.tipo==="laudo") bg="laudo.jpg";
  if(prova.tipo==="testemunha") bg="testemunha.jpg";
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-40">
      <div
        className="bg-slate-900 border border-white/15 rounded-3xl max-w-lg w-full mx-4 p-6 relative overflow-hidden"
      >
        <div
          className="absolute inset-0 opacity-20 bg-cover bg-center"
          style={{backgroundImage:`url('${bg}')`}}
        ></div>
        <div className="relative z-10">
          <h3 className="text-lg font-semibold mb-2">{prova.id} ‚Äî {prova.titulo}</h3>
          <p className="text-sm whitespace-pre-wrap opacity-90 mb-4">{prova.conteudo}</p>
          <button
            onClick={onClose}
            className="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-sm font-semibold"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  );
}

function Escritorio({profile,cases,onSelectCase,onSTJ,onRelatorio,sons}){
  const fila = cases.filter(c=>c.status==="na_fila" && (!profile.court || c.tipo===profile.court));

  return (
    <div className="min-h-screen relative text-white" style={{backgroundImage:"url('escritorio.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}>
      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
      <div className="relative z-10 max-w-6xl mx-auto p-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            {profile.avatar && (
              <img src={profile.avatar} className="w-12 h-12 rounded-full border border-white/40 object-cover" alt="avatar"/>
            )}
            <div>
              <h1 className="text-2xl font-bold">Escrit√≥rio do Juiz</h1>
              <p className="text-xs opacity-80">
                {profile.nome} ‚Äî {profile.cidade}/{profile.estado} ‚Ä¢ {profile.court ? profile.court.toUpperCase() : "sem tribunal"}
              </p>
            </div>
          </div>
          <div className="text-xs text-right opacity-80">
            Julgados: {profile.stats?.julgados||0}<br/>
            Acertos: {profile.stats?.acertos||0}<br/>
            Prest√≠gio: {profile.stats?.prestigio||0}
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-white/10 border border-white/10 rounded-3xl p-5">
            <h2 className="text-lg font-semibold mb-3">Fila de processos</h2>
            <div className="max-h-96 overflow-y-auto space-y-3 pr-2 scroll-thin">
              {fila.length===0 && (
                <p className="text-xs opacity-70">Nenhum processo na fila para este tribunal.</p>
              )}
              {fila.map(c=>(
                <div key={c.id} className="p-3 rounded-2xl bg-white/5 border border-white/10">
                  <h3 className="text-sm font-semibold mb-1">{c.titulo}</h3>
                  <p className="text-xs opacity-80 mb-2">{c.resumo}</p>
                  <button
                    onClick={()=>{sons.gavel.play();onSelectCase(c.id);}}
                    className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                  >
                    Iniciar julgamento
                  </button>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white/10 border border-white/10 rounded-3xl p-5 flex flex-col">
            <h2 className="text-lg font-semibold mb-3">Painel da carreira</h2>
            <p className="text-xs opacity-80 mb-3">
              Acompanhe sua evolu√ß√£o, solicite relat√≥rios e, quando estiver pronto, candidate-se ao STJ.
            </p>
            <button
              onClick={onRelatorio}
              className="mb-2 w-full px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm font-semibold"
            >
              Ver relat√≥rio semestral
            </button>
            <button
              onClick={onSTJ}
              className="w-full px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-sm font-semibold mt-2"
            >
              Candidatar-se ao STJ
            </button>
            <div className="mt-4 text-[10px] opacity-70">
              Simula√ß√£o educacional inspirada em rotinas reais, sem valor jur√≠dico.
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function Julgamento({caso,onVoltar,onFinish,profile,sons}){
  const [falas,setFalas]=useState([]);
  const [pergunta,setPergunta]=useState("");
  const [provaSel,setProvaSel]=useState(null);
  const [jurados,setJurados]=useState([]);
  const [deliberou,setDeliberou]=useState(false);

  useEffect(()=>{
    const inicial=[];
    for(let i=1;i<=12;i++){
      inicial.push({id:i,avatar:`juri${i}.jpg`,voto:null});
    }
    setJurados(inicial);
    setFalas([]);
    setPergunta("");
    setDeliberou(false);
  },[caso.id]);

  async function ouvir(ag){
    const fala=await iaFala(ag,caso,"");
    setFalas(f=>[...f,{autor:ag,texto:fala}]);
    sons.murmur.play();
  }

  async function perguntarIA(){
    if(!pergunta.trim()) return;
    const fala=await iaFala("testemunha",caso,pergunta);
    setFalas(f=>[
      ...f,
      {autor:"juiz",texto:"Pergunta do Juiz: "+pergunta},
      {autor:"testemunha",texto:fala}
    ]);
    setPergunta("");
    sons.murmur.play();
  }

  function decidir(veredito){
    const acertou = veredito===caso.gabarito.culpado;
    onFinish(caso,veredito,acertou);
  }

  function iniciarDeliberacao(){
    if(caso.tipo!=="criminal"){
      alert("Para este tipo de caso (Fam√≠lia, Trabalhista ou STJ) n√£o h√° j√∫ri popular. A decis√£o √© exclusiva do Juiz.");
      return;
    }
    if(deliberou) return;
    const novo = jurados.map(j=>{
      const tendencia = caso.gabarito.culpado?0.7:0.3;
      const r=Math.random();
      const voto = r<tendencia;
      return {...j,voto};
    });
    setJurados(novo);
    setDeliberou(true);
  }

  return (
    <div className="min-h-screen relative text-white"
      style={{backgroundImage:"url('saladejulgamento.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="absolute inset-0 bg-black/75 backdrop-blur-sm"></div>
      <ProvaViewer prova={provaSel} onClose={()=>setProvaSel(null)} />
      <div className="relative z-10 max-w-5xl mx-auto p-6">
        <div className="flex items-center justify-between mb-3">
          <button
            onClick={onVoltar}
            className="px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
          >
            Voltar ao escrit√≥rio
          </button>
          {profile.avatar && (
            <img src={profile.avatar} alt="avatar" className="w-10 h-10 rounded-full border border-white/30 object-cover"/>
          )}
        </div>

        <h1 className="text-2xl font-bold mb-1">Sala de Julgamento</h1>
        <p className="text-xs opacity-80 mb-4">{caso.titulo}</p>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2">
            <div className="mb-3 space-x-2">
              <button
                onClick={()=>ouvir("acusacao")}
                className="px-3 py-1 rounded-xl bg-red-500 hover:bg-red-600 text-xs"
              >
                Ouvir Acusa√ß√£o
              </button>
              <button
                onClick={()=>ouvir("defesa")}
                className="px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs"
              >
                Ouvir Defesa
              </button>
              <button
                onClick={()=>ouvir("testemunha")}
                className="px-3 py-1 rounded-xl bg-amber-500 hover:bg-amber-600 text-xs"
              >
                Ouvir Testemunha
              </button>
            </div>

            <div className="bg-white/5 rounded-3xl border border-white/10 p-4 max-h-72 overflow-y-auto scroll-thin mb-3">
              {falas.length===0 && (
                <p className="text-xs opacity-70">
                  Use os bot√µes acima para ouvir a acusa√ß√£o, a defesa ou uma testemunha. As falas aparecem aqui com efeito de m√°quina de escrever.
                </p>
              )}
              {falas.map((f,i)=>(
                <div key={i} className="mb-3 flex gap-2">
                  {f.autor==="acusacao" && (
                    <img src="promotor.jpg" alt="promotor" className="w-8 h-8 rounded-full object-cover mt-1"/>
                  )}
                  {f.autor==="defesa" && (
                    <img src="advogado.jpg" alt="advogado" className="w-8 h-8 rounded-full object-cover mt-1"/>
                  )}
                  {f.autor==="testemunha" && (
                    <img src="testemunha.jpg" alt="testemunha" className="w-8 h-8 rounded-full object-cover mt-1"/>
                  )}
                  {f.autor==="juiz" && profile.avatar && (
                    <img src={profile.avatar} alt="juiz" className="w-8 h-8 rounded-full object-cover mt-1"/>
                  )}
                  <div className="text-xs bg-black/40 rounded-2xl px-3 py-2 flex-1">
                    <TypewriterText text={f.texto}/>
                  </div>
                </div>
              ))}
            </div>

            <div className="flex gap-2 mb-3">
              <input
                className="flex-1 px-3 py-2 rounded-2xl bg-white/10 text-xs outline-none"
                placeholder="Pergunta do Juiz..."
                value={pergunta}
                onChange={e=>setPergunta(e.target.value)}
                onKeyDown={e=>{if(e.key==="Enter") perguntarIA();}}
              />
              <button
                onClick={perguntarIA}
                className="px-3 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
              >
                Perguntar
              </button>
            </div>

            <div className="flex gap-2 mb-2">
              <button
                onClick={()=>decidir(true)}
                className="px-3 py-2 rounded-2xl bg-red-600 hover:bg-red-700 text-xs font-semibold"
              >
                Condenar
              </button>
              <button
                onClick={()=>decidir(false)}
                className="px-3 py-2 rounded-2xl bg-sky-600 hover:bg-sky-700 text-xs font-semibold"
              >
                Absolver
              </button>
            </div>
          </div>

          <div>
            <div className="bg-white/5 rounded-3xl border border-white/10 p-4 mb-4">
              <h3 className="text-sm font-semibold mb-2">Dossi√™ (Provas)</h3>
              <ul className="text-xs space-y-1">
                {caso.provas.map(p=>(
                  <li key={p.id}>
                    <button
                      onClick={()=>setProvaSel(p)}
                      className="underline hover:text-emerald-300"
                    >
                      [{p.id}] {p.titulo}
                    </button>
                  </li>
                ))}
              </ul>
            </div>

            <div className="bg-white/5 rounded-3xl border border-white/10 p-4">
              <h3 className="text-sm font-semibold mb-2">J√∫ri Popular (12)</h3>
              {caso.tipo!=="criminal" && (
                <p className="text-[11px] opacity-80 mb-2">
                  Para este tipo de a√ß√£o n√£o h√° j√∫ri popular. Clique em <b>Iniciar Delibera√ß√£o</b> para visualizar uma mensagem educativa.
                </p>
              )}
              {caso.tipo==="criminal" && (
                <div className="grid grid-cols-4 gap-2 mb-2">
                  {jurados.map(j=>(
                    <div key={j.id} className="flex flex-col items-center text-[10px]">
                      <img src={j.avatar} alt={"Jur"+j.id} className="w-8 h-8 rounded-full object-cover border border-white/30 mb-1"/>
                      <div className="opacity-70">J{j.id}</div>
                      {j.voto!==null && (
                        <div className={"mt-1 px-1 rounded-full "+(j.voto?"bg-red-600":"bg-sky-600")}>
                          {j.voto?"C":"A"}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
              <button
                onClick={iniciarDeliberacao}
                className="w-full mt-1 px-3 py-2 rounded-2xl bg-amber-500 hover:bg-amber-600 text-[11px] font-semibold"
              >
                Iniciar Delibera√ß√£o
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function STJInfo({profile,onVoltar}){
  const minPrestigio=40;
  const minJulgados=20;
  const p=profile.stats||{prestigio:0,julgados:0};
  const ok=p.prestigio>=minPrestigio && p.julgados>=minJulgados;
  return (
    <div className="min-h-screen relative text-white"
      style={{backgroundImage:"url('stj.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="absolute inset-0 bg-black/75 backdrop-blur-sm"></div>
      <div className="relative z-10 max-w-xl mx-auto p-6">
        <button
          onClick={onVoltar}
          className="mb-4 px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
        >
          Voltar
        </button>
        <h1 className="text-2xl font-bold mb-3">Candidatura ao STJ</h1>
        {!ok && (
          <>
            <p className="text-sm mb-3">
              Para se candidatar ao STJ neste simulador, √© preciso construir experi√™ncia m√≠nima:
            </p>
            <ul className="text-sm list-disc pl-5 space-y-1 mb-4">
              <li>Prest√≠gio m√≠nimo: <b>{minPrestigio}</b> (voc√™ possui {p.prestigio}).</li>
              <li>Casos julgados: <b>{minJulgados}</b> ou mais (voc√™ possui {p.julgados}).</li>
            </ul>
            <p className="text-xs opacity-80">
              Continue julgando com responsabilidade. A cada decis√£o coerente com o gabarito pedag√≥gico,
              seu prest√≠gio aumenta.
            </p>
          </>
        )}
        {ok && (
          <>
            <p className="text-sm mb-3">
              Parab√©ns! Voc√™ atingiu os requisitos m√≠nimos de experi√™ncia. Em uma pr√≥xima vers√£o,
              ser√° liberado o modo especial com casos simulados do STJ e exame objetivo.
            </p>
            <p className="text-xs opacity-80">
              Por enquanto, esta tela serve apenas como objetivo de carreira dentro do curso.
            </p>
          </>
        )}
      </div>
    </div>
  );
}

/* ========= APP PRINCIPAL ========= */

function App(){
  const [stage,setStage]=useState("splash");
  const [profiles,setProfiles]=useState({});
  const [currentProfileName,setCurrentProfileName]=useState(null);
  const [cases,setCases]=useState(seedCases);
  const [currentCaseId,setCurrentCaseId]=useState(null);

  const sons = {
    gavel: useSound(SOUND_URLS.gavel,true,0.7),
    murmur: useSound(SOUND_URLS.murmur,true,0.4)
  };

  useEffect(()=>{
    const saved = localStorage.getItem("juiz_profiles");
    if(saved){
      try{
        setProfiles(JSON.parse(saved));
      }catch(_){}
    }
  },[]);

  const currentProfile = currentProfileName ? profiles[currentProfileName] : null;

  function updateProfile(updater){
    setProfiles(prev=>{
      const atual = prev[currentProfileName];
      if(!atual) return prev;
      const atualizado = updater(atual);
      const novo = {...prev,[currentProfileName]:atualizado};
      localStorage.setItem("juiz_profiles",JSON.stringify(novo));
      return novo;
    });
  }

  function handleSelectCourt(court){
    updateProfile(p=>({...p,court}));
    setStage("location");
  }

  function handleLocation(estado,cidade){
    updateProfile(p=>({...p,estado,cidade}));
    setStage("escritorio");
  }

  function handleSelectCase(id){
    setCurrentCaseId(id);
    setStage("julgamento");
  }

  function handleFinishCase(caso,veredito,acertou){
    setCases(prev=>prev.map(c=>c.id===caso.id?{...c,status:veredito?"condenado":"absolvido"}:c));
    updateProfile(p=>{
      const stats=p.stats||{julgados:0,acertos:0,prestigio:0};
      const julgados=stats.julgados+1;
      const acertos=stats.acertos+(acertou?1:0);
      const prestigio=Math.max(0,Math.min(100,stats.prestigio+(acertou?3:-1)));
      return {...p,stats:{julgados,acertos,prestigio}};
    });
    alert(acertou
      ? "Decis√£o alinhada ao gabarito pedag√≥gico da simula√ß√£o."
      : "Nesta simula√ß√£o, o gabarito indicava solu√ß√£o diferente. Revise o dossi√™ e as falas.");
    setStage("escritorio");
  }

  if(stage==="splash") return <SplashScreen onStart={()=>setStage("tutorial")} />;
  if(stage==="tutorial") return <TutorialSalvamento onContinuar={()=>setStage("login")} />;
  if(stage==="login")
    return (
      <LoginScreen
        profiles={profiles}
        setProfiles={setProfiles}
        setCurrentProfile={setCurrentProfileName}
        onEnter={()=>setStage("court")}
      />
    );
  if(!currentProfile) return null;

  if(stage==="court") return <CourtSelectScreen onSelectCourt={handleSelectCourt} profile={currentProfile} />;
  if(stage==="location") return <LocationSelect profile={currentProfile} onSelectLocation={handleLocation} />;
  if(stage==="escritorio")
    return (
      <Escritorio
        profile={currentProfile}
        cases={cases}
        onSelectCase={handleSelectCase}
        sons={sons}
        onSTJ={()=>setStage("stj")}
        onRelatorio={()=>alert("Relat√≥rio semestral: n√∫mero de julgados, taxa de acerto e coment√°rios pedag√≥gicos podem ser exportados em PDF em vers√£o futura.")}
      />
    );
  if(stage==="julgamento"){
    const caso = cases.find(c=>c.id===currentCaseId);
    if(!caso) return null;
    return (
      <Julgamento
        caso={caso}
        profile={currentProfile}
        sons={sons}
        onVoltar={()=>setStage("escritorio")}
        onFinish={handleFinishCase}
      />
    );
  }
  if(stage==="stj") return <STJInfo profile={currentProfile} onVoltar={()=>setStage("escritorio")} />;

  return null;
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
