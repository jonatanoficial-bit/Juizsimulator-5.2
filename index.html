<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Jogo do Juiz ‚Äî Vale Produ√ß√£o</title>

  <!-- React + ReactDOM + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #root {
      height: 100%;
    }
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    /* scrollbar discreta */
    .thin-scroll::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .thin-scroll::-webkit-scrollbar-track {
      background: transparent;
    }
    .thin-scroll::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.25);
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --------- Dados fixos ---------
    const ESTADOS = {
      "AC":["Rio Branco"],"AL":["Macei√≥"],"AP":["Macap√°"],"AM":["Manaus"],
      "BA":["Salvador","Feira de Santana","Vit√≥ria da Conquista"],
      "CE":["Fortaleza"],"DF":["Bras√≠lia"],"ES":["Vit√≥ria"],"GO":["Goi√¢nia"],
      "MA":["S√£o Lu√≠s"],"MT":["Cuiab√°"],"MS":["Campo Grande"],
      "MG":["Belo Horizonte","Uberl√¢ndia","Juiz de Fora"],
      "PA":["Bel√©m"],"PB":["Jo√£o Pessoa"],"PR":["Curitiba","Londrina"],
      "PE":["Recife"],"PI":["Teresina"],"RJ":["Rio de Janeiro","Niter√≥i"],
      "RN":["Natal"],"RS":["Porto Alegre","Caxias do Sul"],
      "RO":["Porto Velho"],"RR":["Boa Vista"],
      "SC":["Florian√≥polis","Joinville"],
      "SP":["S√£o Paulo","Campinas","Santos","Sorocaba"],
      "SE":["Aracaju"],"TO":["Palmas"]
    };

    const SOUND_URLS = {
      gavel: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_b8e7f6b3a0.mp3?filename=judge-gavel-182004.mp3",
      murmur: "https://cdn.pixabay.com/download/audio/2021/09/16/audio_7b4b2d7f6c.mp3?filename=crowd-murmur-ambient-75537.mp3"
    };

    const AVATARS = {
      acusacao: "promotor.jpg",
      defesa: "advogado.jpg",
      juiz: "stj.jpg" // usamos uma imagem mais s√©ria para o juiz / sistema
    };

    function useSound(url, enabled = true, volume = 0.7) {
      const ref = useRef(null);
      useEffect(() => {
        const a = new Audio(url);
        a.volume = volume;
        ref.current = a;
        return () => { a.pause(); ref.current = null; };
      }, [url]);
      const play = () => {
        if (enabled && ref.current) {
          ref.current.currentTime = 0;
          ref.current.play();
        }
      };
      return { play };
    }

    // efeito de digita√ß√£o simples
    function useTypewriter(text, speed = 18) {
      const [shown, setShown] = useState("");
      useEffect(() => {
        if (!text) {
          setShown("");
          return;
        }
        let i = 0;
        setShown("");
        const id = setInterval(() => {
          i++;
          setShown(text.slice(0, i));
          if (i >= text.length) clearInterval(id);
        }, speed);
        return () => clearInterval(id);
      }, [text, speed]);
      return shown;
    }

    // --------- Casos gerados ---------
    function seedCases() {
      const casos = [];
      let id = 1;

      function addLote(tipo, baseTitulo, baseResumo, gabarito, dificuldade) {
        for (let i = 0; i < 12; i++) {
          casos.push({
            id: tipo + "-" + id++,
            tipo,
            titulo: baseTitulo + " #" + (i + 1),
            resumo: baseResumo,
            dificuldade,
            gabarito, // { culpado: true/false }
            provas: [
              {
                id: "E1",
                tipo: "boletim de ocorr√™ncia",
                conteudo:
                  "Registro oficial com hor√°rio, local, qualifica√ß√£o das partes e breve descri√ß√£o do fato."
              },
              {
                id: "E2",
                tipo: "laudo pericial",
                conteudo:
                  "Laudo t√©cnico assinado por perito habilitado, descrevendo danos, instrumentos e din√¢mica prov√°vel."
              },
              {
                id: "E3",
                tipo: "depoimento de testemunha",
                conteudo:
                  "Testemunha presencial, com trechos convergentes e divergentes em rela√ß√£o √†s vers√µes das partes."
              }
            ],
            status: "na_fila"
          });
        }
      }

      // Criminal
      addLote(
        "criminal",
        "Homic√≠dio em briga de bar",
        "Discuss√£o em estabelecimento que evolui para agress√£o grave com resultado morte.",
        { culpado: true },
        "dif√≠cil"
      );
      addLote(
        "criminal",
        "Roubo em via p√∫blica",
        "Subtra√ß√£o de bens com grave amea√ßa, seguida de fuga e persegui√ß√£o policial.",
        { culpado: true },
        "m√©dio"
      );
      addLote(
        "criminal",
        "Les√£o corporal em contexto dom√©stico",
        "Discuss√£o dom√©stica com alega√ß√µes de empurr√µes e agress√µes m√∫tuas.",
        { culpado: true },
        "m√©dio"
      );

      // Fam√≠lia
      addLote(
        "familia",
        "Revis√£o de alimentos",
        "Pedido de redu√ß√£o ou majora√ß√£o de pens√£o aliment√≠cia por altera√ß√£o de renda.",
        { culpado: false },
        "m√©dio"
      );
      addLote(
        "familia",
        "Guarda compartilhada e conviv√™ncia",
        "Defini√ß√£o de resid√™ncia principal, feriados e f√©rias escolares.",
        { culpado: false },
        "f√°cil"
      );

      // Trabalhista
      addLote(
        "trabalhista",
        "Horas extras habituais",
        "Jornada al√©m do contrato, com discuss√£o sobre banco de horas e intervalos.",
        { culpado: false },
        "m√©dio"
      );
      addLote(
        "trabalhista",
        "V√≠nculo de emprego x PJ",
        "Trabalhador contratado como PJ alega subordina√ß√£o e pessoalidade.",
        { culpado: false },
        "dif√≠cil"
      );

      return casos;
    }

    // --------- IA simulada ---------
    function extrairPalavraChave(pergunta) {
      if (!pergunta) return null;
      const p = pergunta.toLowerCase();
      if (p.includes("laudo") || p.includes("per√≠cia") || p.includes("pericial")) return "laudo";
      if (p.includes("testemunh") || p.includes("depoiment")) return "testemunha";
      if (p.includes("boletim") || p.includes("ocorrencia") || p.includes("ocorr√™ncia")) return "boletim";
      if (p.includes("motiv") || p.includes("inten√ß√£o") || p.includes("dolo")) return "dolo";
      if (p.includes("culpa") || p.includes("neglig√™ncia") || p.includes("imprud√™ncia")) return "culpa";
      return null;
    }

    async function iaFala(agente, caso, pergunta = "") {
      const chave = extrairPalavraChave(pergunta);
      let focoProva = "";

      if (chave === "laudo") focoProva = "destacando principalmente o laudo pericial [E2]. ";
      else if (chave === "testemunha") focoProva = "valorizando os depoimentos testemunhais [E3]. ";
      else if (chave === "boletim") focoProva = "retomando o boletim de ocorr√™ncia [E1] e a din√¢mica registrada. ";
      else if (chave === "dolo") focoProva = "discutindo a inten√ß√£o do agente √† luz da sequ√™ncia de atos e das provas. ";
      else if (chave === "culpa") focoProva = "analisando se houve culpa, neglig√™ncia ou imprud√™ncia na conduta descrita nos autos. ";
      else focoProva = "organizando os principais elementos do dossi√™. ";

      let prefixo;
      let corpo;

      if (agente === "acusacao") {
        prefixo = "ACUSA√á√ÉO ‚Äî ";
        corpo =
          "a Promotoria sustenta que o conjunto probat√≥rio converge para a responsabiliza√ß√£o do r√©u, " +
          focoProva +
          "sob o padr√£o de prova exigido para a condena√ß√£o. Destaca coer√™ncia entre os elementos colhidos e a narrativa da v√≠tima.";
      } else if (agente === "defesa") {
        prefixo = "DEFESA ‚Äî ";
        corpo =
          "a Defesa enfatiza as lacunas, contradi√ß√µes e hip√≥teses alternativas plaus√≠veis, " +
          focoProva +
          "relembrando que a d√∫vida razo√°vel deve favorecer o acusado. Argumenta pela interpreta√ß√£o mais ben√©fica ao r√©u.";
      } else {
        prefixo = "TESTEMUNHA ‚Äî ";
        corpo =
          "o depoente procura esclarecer fatos percebidos no dia, descrevendo hor√°rios, gestos e rea√ß√µes, " +
          focoProva +
          "sem emitir ju√≠zos estritamente jur√≠dicos, mas oferecendo detalhes que auxiliem a reconstru√ß√£o dos acontecimentos.";
      }

      const resumoCaso = "Resumo do caso: " + caso.resumo;
      const texto = prefixo + corpo + " " + resumoCaso;

      // pequena simula√ß√£o de tempo de resposta
      await new Promise(r => setTimeout(r, 400 + Math.random() * 300));
      return texto;
    }

    // --------- Componentes visuais ---------

    function SplashScreen({ onStart }) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-black">
          <div className="relative w-full max-w-md h-[520px] rounded-3xl overflow-hidden shadow-2xl">
            <div className="absolute inset-0 bg-[url('capa.jpg')] bg-cover bg-center" />
            <div className="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-transparent" />
            <div className="relative z-10 h-full flex flex-col items-center justify-end pb-10 px-6">
              <h1 className="text-3xl font-bold mb-1 drop-shadow-lg text-center">
                Tribunal
              </h1>
              <p className="text-lg font-semibold mb-1 drop-shadow-lg text-center">
                Simulador de Juiz
              </p>
              <p className="text-xs opacity-90 mb-4 text-center">
                Vale Produ√ß√£o ‚Ä¢ Vers√£o 5.2 ‚Äî Prot√≥tipo Educacional
              </p>
              <button
                onClick={onStart}
                className="px-6 py-3 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold shadow-xl"
              >
                Iniciar
              </button>
            </div>
          </div>
        </div>
      );
    }

    function TutorialSalvamento({ onContinuar }) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-slate-950 via-slate-900 to-black text-white">
          <div className="max-w-xl w-full mx-4 p-6 rounded-3xl bg-white/5 border border-white/10 backdrop-blur">
            <h2 className="text-2xl font-bold mb-3">Como o jogo salva o seu progresso</h2>
            <ol className="list-decimal pl-5 space-y-2 text-sm">
              <li>
                Cada usu√°rio criado fica gravado no pr√≥prio navegador (carreira local). Se fechar
                o site, ao voltar voc√™ encontra sua carreira.
              </li>
              <li>
                Na tela de login, voc√™ pode{" "}
                <span className="font-semibold">Exportar save</span> em um arquivo
                <code className="px-1 mx-1 rounded bg-black/40 text-[11px]">.json</code>.
              </li>
              <li>
                Em outro computador ou celular, basta clicar em{" "}
                <span className="font-semibold">Importar save</span> e escolher o arquivo para
                continuar do mesmo ponto.
              </li>
            </ol>
            <p className="mt-4 text-xs opacity-80">
              Dica: use sempre o mesmo nome de usu√°rio (ex.: <b>DraMaria</b>) para manter sua
              carreira organizada.
            </p>
            <button
              onClick={onContinuar}
              className="mt-5 px-5 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Entendi, ir para o login
            </button>
          </div>
        </div>
      );
    }

    function LoginScreen({ profiles, setProfiles, setCurrentProfile, onEnter }) {
      const [user, setUser] = useState("");
      const [file, setFile] = useState(null);

      function handleEnter() {
        if (!user.trim()) return;
        const nome = user.trim();
        let updated = { ...profiles };
        if (!updated[nome]) {
          updated[nome] = {
            nome,
            court: null,
            estado: "SP",
            cidade: "S√£o Paulo",
            stats: { julgados: 0, acertos: 0, prestigio: 0 }
          };
        }
        setProfiles(updated);
        localStorage.setItem("juiz_profiles", JSON.stringify(updated));
        setCurrentProfile(nome);
        onEnter();
      }

      function handleExport() {
        const blob = new Blob([JSON.stringify(profiles, null, 2)], {
          type: "application/json"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "jogo-do-juiz-save.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function handleImport() {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = JSON.parse(e.target.result);
            setProfiles(data);
            localStorage.setItem("juiz_profiles", JSON.stringify(data));
            alert("Save importado com sucesso!");
          } catch (err) {
            alert("Arquivo inv√°lido.");
          }
        };
        reader.readAsText(file);
      }

      const nomes = Object.keys(profiles);

      return (
        <div className="min-h-screen bg-[url('capa.jpg')] bg-cover bg-center flex items-center justify-center">
          <div className="bg-black/75 text-white max-w-lg w-full mx-4 p-6 rounded-3xl border border-white/10 backdrop-blur">
            <h1 className="text-xl font-semibold mb-1 text-center">Vale Produ√ß√£o apresenta</h1>
            <h2 className="text-3xl font-bold text-center mb-4">Jogo do Juiz</h2>
            <p className="text-xs text-center mb-4 opacity-80">
              Crie seu usu√°rio ou escolha um j√° existente. Voc√™ pode exportar e importar sua
              carreira quando quiser.
            </p>

            <div className="space-y-3">
              <div>
                <label className="text-xs opacity-80">Usu√°rio</label>
                <input
                  className="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 outline-none text-sm"
                  value={user}
                  onChange={e => setUser(e.target.value)}
                  placeholder="Ex.: DraMaria, EstudanteJo√£o..."
                />
              </div>

              <div className="flex gap-2">
                <button
                  onClick={handleEnter}
                  className="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
                >
                  Entrar / Criar perfil
                </button>
                <button
                  onClick={handleExport}
                  className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
                >
                  Exportar save
                </button>
              </div>

              <div className="mt-2 text-xs">
                <div className="mb-1">Importar save:</div>
                <input
                  type="file"
                  accept=".json"
                  onChange={e => setFile(e.target.files[0] || null)}
                  className="text-xs"
                />
                <button
                  onClick={handleImport}
                  className="ml-2 px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs"
                >
                  Importar
                </button>
              </div>
            </div>

            {nomes.length > 0 && (
              <div className="mt-4">
                <div className="text-xs mb-1 opacity-70">Perfis existentes:</div>
                <div className="flex flex-wrap gap-2">
                  {nomes.map(n => (
                    <button
                      key={n}
                      onClick={() => setUser(n)}
                      className="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 text-xs"
                    >
                      {n}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function CourtSelectScreen({ onSelectCourt }) {
      const courts = [
        {
          id: "criminal",
          icon: "‚öñÔ∏è",
          nome: "Criminal",
          desc: "Crimes contra a pessoa e o patrim√¥nio."
        },
        {
          id: "familia",
          icon: "üë®‚Äçüë©‚Äçüëß",
          nome: "Fam√≠lia",
          desc: "Guarda, pens√£o, div√≥rcio e medidas protetivas."
        },
        {
          id: "trabalhista",
          icon: "üíº",
          nome: "Trabalhista",
          desc: "V√≠nculo, verbas, jornada e danos morais."
        }
      ];
      return (
        <div className="min-h-screen bg-black flex items-center justify-center text-white">
          <div className="max-w-4xl w-full mx-4 p-6">
            <h2 className="text-3xl font-bold mb-6 text-center">Escolha o Tribunal</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
              {courts.map(c => (
                <button
                  key={c.id}
                  onClick={() => onSelectCourt(c.id)}
                  className="p-5 rounded-3xl bg-white/10 border border-white/15 hover:bg-white/20 transition text-left"
                >
                  <div className="text-3xl mb-2">{c.icon}</div>
                  <div className="text-lg font-semibold">{c.nome}</div>
                  <p className="text-xs opacity-80 mt-1">{c.desc}</p>
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function LocationSelect({ profile, onSelectLocation }) {
      const [estado, setEstado] = useState(profile.estado || "SP");
      const cidadesUF = ESTADOS[estado] || [];
      const [cidade, setCidade] = useState(profile.cidade || cidadesUF[0] || "");

      return (
        <div className="min-h-screen bg-black text-white flex items-center justify-center">
          <div className="bg-white/10 p-6 rounded-3xl max-w-md w-full mx-4 border border-white/10">
            <h2 className="text-2xl font-bold mb-4">Escolha a comarca</h2>
            <div className="mb-3">
              <label className="text-xs opacity-80">Estado</label>
              <select
                value={estado}
                onChange={e => {
                  const uf = e.target.value;
                  setEstado(uf);
                  const lista = ESTADOS[uf] || [];
                  setCidade(lista[0] || "");
                }}
                className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
              >
                {Object.keys(ESTADOS).map(uf => (
                  <option key={uf} value={uf}>
                    {uf}
                  </option>
                ))}
              </select>
            </div>
            <div className="mb-4">
              <label className="text-xs opacity-80">Cidade</label>
              <select
                value={cidade}
                onChange={e => setCidade(e.target.value)}
                className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
              >
                {(ESTADOS[estado] || []).map(c => (
                  <option key={c} value={c}>
                    {c}
                  </option>
                ))}
              </select>
            </div>
            <button
              onClick={() => onSelectLocation(estado, cidade)}
              className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Confirmar
            </button>
          </div>
        </div>
      );
    }

    function ProvaViewer({ prova, onClose }) {
      if (!prova) return null;
      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-40">
          <div className="bg-slate-900 border border-white/15 rounded-3xl max-w-lg w-full mx-4 p-6">
            <h3 className="text-lg font-semibold mb-2">
              {prova.id} ‚Äî {prova.tipo}
            </h3>
            <p className="text-sm whitespace-pre-wrap opacity-90 mb-4">{prova.conteudo}</p>
            <button
              onClick={onClose}
              className="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-sm font-semibold"
            >
              Fechar
            </button>
          </div>
        </div>
      );
    }

    function Escritorio({ profile, cases, onSelectCase, onRelatorio, onSTJ, sons }) {
      const fila = cases.filter(c => c.status === "na_fila" && c.tipo === profile.court);

      return (
        <div className="min-h-screen relative bg-[url('escritorio.jpg')] bg-cover bg-center text-white">
          <div className="absolute inset-0 bg-black/65 backdrop-blur-sm"></div>
          <div className="relative z-10 max-w-6xl mx-auto p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h1 className="text-2xl font-bold">Escrit√≥rio do Juiz</h1>
                <p className="text-xs opacity-80">
                  {profile.nome} ‚Äî {profile.cidade}/{profile.estado} ‚Ä¢{" "}
                  {profile.court === "criminal"
                    ? "Vara Criminal"
                    : profile.court === "familia"
                    ? "Vara de Fam√≠lia"
                    : profile.court === "trabalhista"
                    ? "Vara do Trabalho"
                    : "Sem tribunal"}
                </p>
              </div>
              <div className="text-xs text-right opacity-80">
                Casos julgados: {profile.stats?.julgados || 0}
                <br />
                Acertos (gabarito): {profile.stats?.acertos || 0}
                <br />
                Prest√≠gio: {profile.stats?.prestigio || 0}%
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white/10 border border-white/10 rounded-3xl p-5">
                <h2 className="text-lg font-semibold mb-3">Fila de processos</h2>
                <div className="max-h-96 overflow-y-auto thin-scroll space-y-3 pr-2">
                  {fila.length === 0 && (
                    <p className="text-xs opacity-70">
                      Nenhum processo na fila para este tribunal. (No futuro, mais casos ser√£o
                      adicionados).
                    </p>
                  )}
                  {fila.map(c => (
                    <div
                      key={c.id}
                      className="p-3 rounded-2xl bg-white/5 border border-white/10"
                    >
                      <h3 className="text-sm font-semibold mb-1">{c.titulo}</h3>
                      <p className="text-xs opacity-80 mb-1">{c.resumo}</p>
                      <p className="text-[10px] opacity-70 mb-2">
                        Dificuldade:{" "}
                        {c.dificuldade === "f√°cil"
                          ? "F√°cil"
                          : c.dificuldade === "m√©dio"
                          ? "M√©dio"
                          : "Dif√≠cil"}
                      </p>
                      <button
                        onClick={() => {
                          sons.gavel.play();
                          onSelectCase(c.id);
                        }}
                        className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                      >
                        Iniciar julgamento
                      </button>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-white/10 border border-white/10 rounded-3xl p-5 flex flex-col">
                <h2 className="text-lg font-semibold mb-3">Painel da carreira</h2>
                <p className="text-xs opacity-80 mb-3">
                  Acompanhe sua evolu√ß√£o semestral, identifique em quais tipos de casos voc√™
                  acerta mais e aprofunde seu estudo.
                </p>
                <button
                  onClick={onRelatorio}
                  className="mb-2 w-full px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm font-semibold"
                >
                  Ver relat√≥rio semestral
                </button>
                {profile.stats?.prestigio >= 40 && (
                  <button
                    onClick={onSTJ}
                    className="w-full px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-sm font-semibold mt-2"
                  >
                    Candidatar-se simbolicamente ao STJ
                  </button>
                )}
                <div className="mt-4 text-[10px] opacity-70">
                  Simula√ß√£o educacional inspirada em rotinas reais, sem valor jur√≠dico.
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function FalasArea({ falas }) {
      const last = falas[falas.length - 1];
      const typed = useTypewriter(last ? last.texto : "", 16);

      return (
        <div className="space-y-3 max-h-80 thin-scroll overflow-y-auto pr-1">
          {falas.map((f, idx) => {
            const isLast = idx === falas.length - 1;
            const avatarSrc =
              f.autor === "acusacao"
                ? AVATARS.acusacao
                : f.autor === "defesa"
                ? AVATARS.defesa
                : f.autor === "juiz"
                ? AVATARS.juiz
                : null;
            const nomeAutor =
              f.autor === "acusacao"
                ? "Promotoria"
                : f.autor === "defesa"
                ? "Defesa"
                : f.autor === "juiz"
                ? "Juiz"
                : "Testemunha";

            return (
              <div
                key={idx}
                className={`flex items-start gap-3 ${
                  f.autor === "defesa" ? "flex-row-reverse text-right" : ""
                }`}
              >
                <div className="w-10 h-10 rounded-full overflow-hidden bg-white/10 flex-shrink-0">
                  {avatarSrc ? (
                    <img
                      src={avatarSrc}
                      alt={nomeAutor}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-xs opacity-70">
                      {nomeAutor[0]}
                    </div>
                  )}
                </div>
                <div className="flex-1">
                  <div className="text-[11px] opacity-70 mb-1">{nomeAutor}</div>
                  <div className="rounded-2xl bg-white/10 px-3 py-2 text-xs leading-relaxed">
                    {isLast ? typed : f.texto}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    function Julgamento({ caso, onVeredito, onVoltar, sons }) {
      const [falas, setFalas] = useState([]);
      const [pergunta, setPergunta] = useState("");
      const [provaSel, setProvaSel] = useState(null);
      const [jurados, setJurados] = useState(
        Array.from({ length: 12 }, (_, i) => ({
          id: i + 1,
          voto: null
        }))
      );

      async function ouvir(agente) {
        const fala = await iaFala(agente, caso, "");
        setFalas(f => [...f, { autor: agente, texto: fala }]);
        sons.murmur.play();
      }

      async function perguntarIA() {
        if (!pergunta.trim()) return;
        const perguntaTxt = pergunta.trim();
        setFalas(f => [...f, { autor: "juiz", texto: "Pergunta do Juiz: " + perguntaTxt }]);
        setPergunta("");
        const fala = await iaFala("testemunha", caso, perguntaTxt);
        setFalas(f => [...f, { autor: "testemunha", texto: fala }]);
        sons.murmur.play();
      }

      function deliberarJuri() {
        const novo = jurados.map(j => {
          const voto = Math.random() < 0.6; // leve tend√™ncia √† condena√ß√£o
          return { ...j, voto };
        });
        setJurados(novo);
        sons.murmur.play();
      }

      function decidir(veredito) {
        sons.gavel.play();
        onVeredito(veredito);
      }

      const votosCulpado = jurados.filter(j => j.voto === true).length;
      const votosAbsolver = jurados.filter(j => j.voto === false).length;

      return (
        <div className="min-h-screen relative bg-[url('saladejulgamento.jpg')] bg-cover bg-center text-white">
          <div className="absolute inset-0 bg-black/75 backdrop-blur-sm"></div>
          <ProvaViewer prova={provaSel} onClose={() => setProvaSel(null)} />
          <div className="relative z-10 max-w-6xl mx-auto p-6">
            <button
              onClick={onVoltar}
              className="mb-4 px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
            >
              ‚Üê Voltar ao escrit√≥rio
            </button>
            <h1 className="text-2xl font-bold mb-1">Sala de Julgamento</h1>
            <p className="text-xs opacity-80 mb-4">{caso.titulo} ‚Äî {caso.resumo}</p>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 bg-white/10 border border-white/15 rounded-3xl p-4">
                <div className="flex flex-wrap gap-2 mb-3">
                  <button
                    onClick={() => ouvir("acusacao")}
                    className="px-3 py-1 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold"
                  >
                    Ouvir Acusa√ß√£o
                  </button>
                  <button
                    onClick={() => ouvir("defesa")}
                    className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                  >
                    Ouvir Defesa
                  </button>
                </div>

                <FalasArea falas={falas} />

                <div className="mt-4">
                  <div className="text-xs opacity-80 mb-1">
                    Pergunta do juiz (Enter envia, A = acusa√ß√£o, D = defesa):
                  </div>
                  <div className="flex gap-2">
                    <input
                      value={pergunta}
                      onChange={e => setPergunta(e.target.value)}
                      onKeyDown={e => {
                        if (e.key === "Enter") perguntarIA();
                        if (e.key.toLowerCase() === "a") ouvir("acusacao");
                        if (e.key.toLowerCase() === "d") ouvir("defesa");
                      }}
                      className="flex-1 rounded-xl bg-white/10 px-3 py-2 text-xs outline-none"
                      placeholder="Ex.: Pergunte sobre o laudo pericial, contradi√ß√µes da testemunha, motiva√ß√£o do r√©u..."
                    />
                    <button
                      onClick={perguntarIA}
                      className="px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold"
                    >
                      Perguntar
                    </button>
                  </div>
                </div>
              </div>

              <div className="bg-white/10 border border-white/15 rounded-3xl p-4 space-y-4">
                <div>
                  <h2 className="text-sm font-semibold mb-1">Dossi√™ (provas)</h2>
                  <ul className="text-[11px] thin-scroll max-h-40 overflow-y-auto pr-1">
                    {caso.provas.map(p => (
                      <li
                        key={p.id}
                        className="mb-2 cursor-pointer hover:text-emerald-300"
                        onClick={() => setProvaSel(p)}
                      >
                        <span className="font-semibold">[{p.id}]</span> {p.tipo}
                      </li>
                    ))}
                  </ul>
                  <p className="text-[10px] opacity-60">
                    Clique em uma prova para ler o conte√∫do detalhado.
                  </p>
                </div>

                <div>
                  <h2 className="text-sm font-semibold mb-1">J√∫ri Popular (12)</h2>
                  <div className="grid grid-cols-4 gap-2 text-[10px]">
                    {jurados.map(j => (
                      <div
                        key={j.id}
                        className={`rounded-xl px-2 py-2 text-center border ${
                          j.voto === null
                            ? "bg-white/5 border-white/15"
                            : j.voto
                            ? "bg-red-500/60 border-red-300"
                            : "bg-emerald-500/60 border-emerald-300"
                        }`}
                      >
                        J{String(j.id).padStart(2, "0")}
                        <div className="mt-1 text-[9px]">
                          {j.voto === null ? "‚Äî" : j.voto ? "C" : "A"}
                        </div>
                      </div>
                    ))}
                  </div>
                  <button
                    onClick={deliberarJuri}
                    className="mt-2 w-full px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-[11px]"
                  >
                    Iniciar delibera√ß√£o
                  </button>
                  <p className="text-[10px] opacity-70 mt-1">
                    C = condenar, A = absolver. J√∫ri √© apenas indicativo na simula√ß√£o.
                  </p>
                  <p className="text-[10px] mt-1">
                    Votos: {votosCulpado} pela condena√ß√£o, {votosAbsolver} pela absolvi√ß√£o.
                  </p>
                </div>

                <div>
                  <h2 className="text-sm font-semibold mb-1">Veredito do Juiz</h2>
                  <div className="flex gap-2">
                    <button
                      onClick={() => decidir(true)}
                      className="flex-1 px-3 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold"
                    >
                      Condenar
                    </button>
                    <button
                      onClick={() => decidir(false)}
                      className="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                    >
                      Absolver
                    </button>
                  </div>
                  <p className="text-[10px] opacity-70 mt-1">
                    A simula√ß√£o compara sua decis√£o com um gabarito t√©cnico apenas para fins
                    did√°ticos.
                  </p>
                </div>
              </div>
            </div>

            <p className="mt-4 text-[10px] opacity-60">
              Simula√ß√£o educacional ‚Äî n√£o substitui consulta a profissional do Direito.
            </p>
          </div>
        </div>
      );
    }

    // --------- APP PRINCIPAL ---------
    function App() {
      const [screen, setScreen] = useState("splash");
      const [profiles, setProfiles] = useState(() => {
        try {
          const raw = localStorage.getItem("juiz_profiles");
          return raw ? JSON.parse(raw) : {};
        } catch {
          return {};
        }
      });
      const [currentProfileId, setCurrentProfileId] = useState(null);
      const [cases, setCases] = useState(() => seedCases());
      const [currentCaseId, setCurrentCaseId] = useState(null);

      // sons globais
      const gavel = useSound(SOUND_URLS.gavel, true, 0.9);
      const murmur = useSound(SOUND_URLS.murmur, true, 0.4);
      const sons = { gavel, murmur };

      const currentProfile = currentProfileId ? profiles[currentProfileId] : null;
      const currentCase = currentCaseId
        ? cases.find(c => c.id === currentCaseId)
        : null;

      function updateProfile(p) {
        setProfiles(prev => {
          const updated = { ...prev, [p.nome]: p };
          localStorage.setItem("juiz_profiles", JSON.stringify(updated));
          return updated;
        });
      }

      function handleVeredito(culpado) {
        if (!currentCase || !currentProfile) return;
        // atualiza casos
        setCases(prev =>
          prev.map(c =>
            c.id === currentCase.id
              ? { ...c, status: culpado ? "condenado" : "absolvido" }
              : c
          )
        );
        // atualiza stats
        const acertou =
          !!currentCase.gabarito && culpado === !!currentCase.gabarito.culpado;
        const stats = { ...(currentProfile.stats || {}) };
        stats.julgados = (stats.julgados || 0) + 1;
        stats.acertos = (stats.acertos || 0) + (acertou ? 1 : 0);
        const IAJ = stats.julgados ? stats.acertos / stats.julgados : 0;
        stats.prestigio = Math.min(
          100,
          Math.round(IAJ * 70 + Math.min(30, stats.julgados * 2))
        );
        const novoProfile = { ...currentProfile, stats };
        updateProfile(novoProfile);
        setCurrentCaseId(null);
        setScreen("escritorio");
        alert(
          acertou
            ? "Decis√£o alinhada ao gabarito t√©cnico da simula√ß√£o."
            : "Nesta simula√ß√£o, o gabarito t√©cnico apontava solu√ß√£o diferente. Use isso como oportunidade de estudo."
        );
      }

      function abrirRelatorio() {
        if (!currentProfile) return;
        const s = currentProfile.stats || { julgados: 0, acertos: 0, prestigio: 0 };
        const IAJ = s.julgados ? Math.round((s.acertos / s.julgados) * 100) : 0;
        alert(
          "RELAT√ìRIO SEMESTRAL (resumido)\n\n" +
            "Casos julgados: " +
            s.julgados +
            "\n" +
            "Acertos de acordo com o gabarito: " +
            s.acertos +
            "\n" +
            "IAJ (√çndice de Ader√™ncia Jur√≠dica): " +
            IAJ +
            "%\n" +
            "Prest√≠gio simulado: " +
            s.prestigio +
            "%\n\n" +
            "Use esses n√∫meros para avaliar em quais √°reas voc√™ precisa estudar mais."
        );
      }

      function candidaturaSTJ() {
        alert(
          "Parab√©ns! Sua carreira alcan√ßou prest√≠gio suficiente para, simbolicamente, candidatar-se ao STJ.\n\n" +
            "Em futuras vers√µes, essa etapa poder√° destravar casos especiais de repercuss√£o geral."
        );
      }

      // navega√ß√£o de telas
      if (screen === "splash") {
        return <SplashScreen onStart={() => setScreen("tutorial")} />;
      }

      if (screen === "tutorial") {
        return <TutorialSalvamento onContinuar={() => setScreen("login")} />;
      }

      if (screen === "login") {
        return (
          <LoginScreen
            profiles={profiles}
            setProfiles={setProfiles}
            setCurrentProfile={id => {
              setCurrentProfileId(id);
            }}
            onEnter={() => setScreen("court")}
          />
        );
      }

      if (!currentProfile) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-black text-white">
            <p className="text-sm">Nenhum perfil selecionado. Volte ao login.</p>
          </div>
        );
      }

      if (screen === "court") {
        return (
          <CourtSelectScreen
            onSelectCourt={court => {
              const novo = { ...currentProfile, court };
              updateProfile(novo);
              setScreen("location");
            }}
          />
        );
      }

      if (screen === "location") {
        return (
          <LocationSelect
            profile={currentProfile}
            onSelectLocation={(estado, cidade) => {
              const novo = { ...currentProfile, estado, cidade };
              updateProfile(novo);
              setScreen("escritorio");
            }}
          />
        );
      }

      if (screen === "julgamento" && currentCase) {
        return (
          <Julgamento
            caso={currentCase}
            onVeredito={handleVeredito}
            onVoltar={() => {
              setCurrentCaseId(null);
              setScreen("escritorio");
            }}
            sons={sons}
          />
        );
      }

      return (
        <Escritorio
          profile={currentProfile}
          cases={cases}
          onSelectCase={id => {
            setCurrentCaseId(id);
            setScreen("julgamento");
          }}
          onRelatorio={abrirRelatorio}
          onSTJ={candidaturaSTJ}
          sons={sons}
        />
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
