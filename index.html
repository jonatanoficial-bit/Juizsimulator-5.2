<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jogo do Juiz – Vale Produção</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #root { height: 100%; }
    body {
      margin: 0;
      background: #020617;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    /* animação máquina de escrever */
    .typewriter {
      overflow: hidden;
      white-space: pre-wrap;
      border-right: .15em solid rgba(248,250,252,0.5);
      animation: caret 0.7s steps(1) infinite;
    }
    @keyframes caret {
      50% { border-color: transparent; }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* -------------------- CONFIG DE IMAGENS -------------------- */
/* Mantenha estes nomes exatamente iguais às imagens do GitHub  */
const IMG = {
  capa: "capa.jpg",
  escritorio: "escritorio.jpg",
  sala: "saladejulgamento.jpg",
  stj: "stj.jpg",
  promotor: "promotor.jpg",
  defesa: "advogado.jpg",
  testemunha: "testemunha.jpg",
  bo: "bo.jpg",
  laudo: "laudo.jpg",
  pericia: "laudo.jpg", // usa mesmo fundo do laudo
  avatar: (i) => `avatar${i}.jpg`,
  juri: (i) => `juri${i}.jpg`
};

/* -------------------- DADOS FIXOS -------------------- */

const ESTADOS = {
  "AC":["Rio Branco"],"AL":["Maceió"],"AP":["Macapá"],"AM":["Manaus"],
  "BA":["Salvador","Feira de Santana","Vitória da Conquista"],
  "CE":["Fortaleza"],"DF":["Brasília"],"ES":["Vitória"],"GO":["Goiânia"],
  "MA":["São Luís"],"MT":["Cuiabá"],"MS":["Campo Grande"],
  "MG":["Belo Horizonte","Uberlândia","Juiz de Fora"],
  "PA":["Belém"],"PB":["João Pessoa"],"PR":["Curitiba","Londrina"],
  "PE":["Recife"],"PI":["Teresina"],"RJ":["Rio de Janeiro","Niterói"],
  "RN":["Natal"],"RS":["Porto Alegre","Caxias do Sul"],
  "RO":["Porto Velho"],"RR":["Boa Vista"],
  "SC":["Florianópolis","Joinville"],
  "SP":["São Paulo","Campinas","Santos","Sorocaba"],
  "SE":["Aracaju"],"TO":["Palmas"]
};

const JURY_AVATARS = Array.from({length:12},(_,i)=>IMG.juri(i+1));

const SOUND_URLS = {
  gavel: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_b8e7f6b3a0.mp3?filename=judge-gavel-182004.mp3",
  murmur: "https://cdn.pixabay.com/download/audio/2021/09/16/audio_7b4b2d7f6c.mp3?filename=crowd-murmur-ambient-75537.mp3"
};

function useSound(url, enabled=true, volume=0.7){
  const ref = useRef(null);
  useEffect(()=>{
    const a = new Audio(url);
    a.volume = volume;
    ref.current = a;
    return ()=>{ a.pause(); ref.current = null; };
  },[url]);
  const play = ()=>{ if(enabled && ref.current){ ref.current.currentTime = 0; ref.current.play(); } };
  return { play };
}

/* -------------------- GERADOR DE CASOS -------------------- */

function makeDocs(titulo,resumo,tipo){
  const baseContexto =
    tipo==="criminal"
      ? "Contexto: processo criminal, com investigação policial, oitiva de testemunhas e avaliação de materialidade e autoria.\n\n"
      : tipo==="familia"
        ? "Contexto: processo de família, com foco em melhor interesse de crianças/adolescentes e equilíbrio das relações familiares.\n\n"
        : tipo==="trabalhista"
          ? "Contexto: processo trabalhista, analisando vínculo, jornada, verbas e eventuais danos morais.\n\n"
          : "Contexto: recurso especial em instância superior, focado em interpretação de lei federal e precedentes.\n\n";

  return {
    bo: (
      "BOLETIM DE OCORRÊNCIA\n\n" +
      "Título: " + titulo + "\n\n" +
      baseContexto +
      "Síntese fático-cronológica dos acontecimentos, identificando partes, horário aproximado, local do fato, " +
      "intervenção das autoridades e primeiras providências adotadas.\n\n" +
      "Resumo do caso: " + resumo
    ),
    laudo: (
      "LAUDO PERICIAL / PERÍCIA PRINCIPAL\n\n" +
      "Objeto: análise técnica dos vestígios e documentos relacionados ao caso \"" + titulo + "\".\n\n" +
      "Principais constatações:\n" +
      "- Descrição minuciosa de danos, registros, documentos, exames ou provas materiais relevantes.\n" +
      "- Indicação de compatibilidades ou incompatibilidades entre a narrativa das partes e os vestígios.\n\n" +
      "Conclusão técnica: avaliação imparcial, indicando hipóteses mais prováveis à luz da ciência aplicada.\n\n" +
      "Resumo do caso: " + resumo
    ),
    pericia: (
      "LAUDO PERICIAL COMPLEMENTAR\n\n" +
      "Finalidade: aprofundar pontos específicos solicitados pelo Juízo ou pelas partes, " +
      "esclarecendo dúvidas levantadas na perícia principal.\n\n" +
      "Análises adicionais:\n" +
      "- Releitura de documentos, exames e registros sob novo foco.\n" +
      "- Verificação de versões divergentes com base no mesmo conjunto probatório.\n\n" +
      "Síntese final: consolidação das informações técnicas, reforçando a coerência (ou ausência dela) " +
      "entre os vestígios e as narrativas em juízo.\n\n" +
      "Resumo do caso: " + resumo
    )
  };
}

function seedCases(){
  const casos = [];
  let id = 1;

  function addLote(tipo, baseTitulos, baseResumos, culpadoDefault, quantidade){
    for(let i=1;i<=quantidade;i++){
      const t = baseTitulos[(i-1)%baseTitulos.length];
      const r = baseResumos[(i-1)%baseResumos.length];
      const docs = makeDocs(t, r, tipo);
      casos.push({
        id: tipo.toUpperCase()+"-"+id++,
        tipo,
        titulo: t + " #" + i,
        resumo: r,
        dificuldade: (i%3===0?"alta": i%2===0?"média":"baixa"),
        gabarito:{culpado:culpadoDefault},
        status:"na_fila",
        docs
      });
    }
  }

  addLote("criminal",
    [
      "Homicídio simples em briga de bar",
      "Roubo em transporte público",
      "Furto qualificado em residência",
      "Lesão corporal em evento esportivo"
    ],
    [
      "Discussão que evolui para agressão grave com resultado morte em estabelecimento lotado.",
      "Subtração de bens de passageiro mediante grave ameaça dentro de ônibus urbano.",
      "Invasão de residência com arrombamento em período noturno, com subtração de eletrônicos.",
      "Conflito entre torcidas que resulta em lesões múltiplas e divergência entre versões."
    ],
    true,
    40
  );

  addLote("familia",
    [
      "Revisão de pensão alimentícia",
      "Definição de guarda compartilhada",
      "Regulamentação de visitas em outra cidade",
      "Medida protetiva por violência doméstica"
    ],
    [
      "Alteração do valor de pensão em razão de mudança significativa de renda do alimentante.",
      "Fixação de regime de convivência equilibrado entre genitores e filho menor.",
      "Organização de calendário de visitas diante da mudança de domicílio de um dos genitores.",
      "Pedido de proteção urgente diante de histórico de agressões e ameaças."
    ],
    false,
    40
  );

  addLote("trabalhista",
    [
      "Horas extras habituais sem registro",
      "Reconhecimento de vínculo de emprego",
      "Assédio moral em ambiente de trabalho",
      "Acidente típico com afastamento prolongado"
    ],
    [
      "Empregado alega jornadas diárias superiores ao contrato sem correta remuneração.",
      "Trabalhador formalmente PJ busca reconhecimento de vínculo empregatício.",
      "Relatos de humilhações reiteradas por superior hierárquico diante de colegas.",
      "Queda em serviço com sequelas e discussão sobre responsabilidade do empregador."
    ],
    false,
    40
  );

  // Novos ramos adicionados na Versão 6.3 Plus (Civil, Tributário e Ambiental)
  addLote("civil",
    [
      "Ação de cobrança de dívida contratual",
      "Indenização por danos morais por atraso em voo",
      "Rescisão de contrato de locação",
      "Responsabilidade civil por acidente de trânsito"
    ],
    [
      "Disputa envolvendo inadimplemento de prestação de serviços e cobrança judicial.",
      "Passageiro requer indenização por transtornos decorrentes de atraso superior a 4 horas.",
      "Locador pretende rescindir contrato por falta de pagamento e despejo do inquilino.",
      "Acidente em via pública com discussão sobre culpa e reparação de danos materiais e morais."
    ],
    false,
    40
  );

  addLote("tributario",
    [
      "Execução fiscal de IPTU",
      "Contestação de multa por sonegação",
      "Compensação de créditos tributários",
      "Imunidade tributária de entidade beneficente"
    ],
    [
      "Município cobra impostos atrasados de contribuinte que alega prescrição.",
      "Contribuinte contesta autuação e multa aplicada por suposta sonegação.",
      "Empresa busca compensar tributos pagos a maior em exercícios anteriores.",
      "Organização social pleiteia reconhecimento de imunidade constitucional."
    ],
    true,
    40
  );

  addLote("ambiental",
    [
      "Desmatamento em área de preservação",
      "Poluição de rio por indústria",
      "Construção irregular em zona costeira",
      "Uso de agrotóxicos proibidos"
    ],
    [
      "Proprietário rural é acusado de suprimir vegetação em área de APP sem licença.",
      "Empresa é responsabilizada por despejo de efluentes contaminados em curso d'água.",
      "Empreendedor ergue edificação em área de proteção permanente no litoral.",
      "Produtor agrícola utiliza defensivos não autorizados causando danos à fauna."
    ],
    true,
    40
  );

  addLote("stj",
    [
      "Recurso especial em matéria criminal",
      "Recurso especial em direito de família",
      "Recurso especial em direito do trabalho",
      "Recurso especial sobre competência"
    ],
    [
      "Discussão sobre interpretação de norma federal em precedente criminal relevante.",
      "Divergência entre tribunais acerca de partilha e alimentos.",
      "Uniformização de entendimento sobre verbas trabalhistas de natureza indenizatória.",
      "Definição de qual justiça é competente para julgar o caso concreto."
    ],
    false,
    40
  );

  return casos;
}

/* -------------------- IA SIMULADA -------------------- */

async function iaFala(agente, caso, pergunta=""){
  const prefixo =
    agente==="acusacao" ? "PROMOTOR: " :
    agente==="defesa" ? "DEFESA: " :
    "TESTEMUNHA: ";

  const focoPergunta = pergunta
    ? `Respondendo à pergunta do Juiz: "${pergunta}". `
    : "";

  let corpo;
  if(agente==="acusacao"){
    corpo =
      "A acusação organiza os elementos que apontam para a responsabilidade da parte ré, destacando coerência entre boletim, laudos e depoimentos. ";
  } else if(agente==="defesa"){
    corpo =
      "A defesa ressalta lacunas, contradições e alternativas interpretativas que favorecem a dúvida razoável e a preservação de direitos fundamentais. ";
  } else {
    corpo =
      "Eu, enquanto testemunha, descrevo em primeira pessoa o que vi e ouvi: narro o ambiente, as pessoas, a sequência dos fatos e o meu posicionamento físico em relação ao acontecimento, sem emitir juízo jurídico, apenas relatando a experiência vivida. ";
  }

  const docRef =
    caso && caso.docs
      ? "Os documentos oficiais (boletim, laudos e perícia complementar) reforçam detalhes importantes que o Juiz pode consultar no dossiê. "
      : "";

  const resumo = "Resumo do caso: " + caso.resumo;

  const texto = prefixo + focoPergunta + corpo + docRef + resumo;

  await new Promise(r=>setTimeout(r,350));
  return texto;
}

/* -------------------- COMPONENTES -------------------- */

function SplashScreen({onStart}){
  return (
    <div className="min-h-screen flex items-center justify-center bg-black">
      <div
        className="relative w-full max-w-md h-[520px] rounded-3xl overflow-hidden shadow-2xl"
        style={{backgroundImage:`url('${IMG.capa}')`, backgroundSize:"cover", backgroundPosition:"center"}}
      >
        <div className="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent" />
        <div className="relative z-10 h-full flex flex-col items-center justify-end pb-10 px-6 text-white">
          <h1 className="text-3xl font-bold mb-1 drop-shadow-lg text-center">Tribunal</h1>
          <p className="text-lg font-semibold mb-2 drop-shadow-lg text-center">Simulador de Juiz</p>
          <p className="text-xs opacity-90 mb-4 text-center">Vale Produção • Versão 6.3 Plus</p>
          <button
            onClick={onStart}
            className="px-6 py-3 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold shadow-xl"
          >
            Iniciar
          </button>
        </div>
      </div>
    </div>
  );
}

function TutorialSalvamento({onContinuar}){
  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white">
      <div className="max-w-xl w-full mx-4 p-6 rounded-3xl bg-slate-900 border border-white/10 shadow-xl">
        <h2 className="text-2xl font-bold mb-3">Como o jogo salva seu progresso</h2>
        <ol className="list-decimal pl-5 space-y-2 text-sm">
          <li>Seu perfil é salvo automaticamente neste navegador (localStorage).</li>
          <li>Na tela de login você pode <b>Exportar</b> um arquivo de backup <code>.json</code>.</li>
          <li>Em outro dispositivo, use <b>Importar</b> para continuar do ponto em que parou.</li>
          <li>Use sempre o mesmo nome de usuário para manter sua carreira organizada.</li>
        </ol>
        <p className="mt-4 text-xs opacity-80">
          Importante: este é um simulador educacional. Nenhuma decisão aqui tem efeito jurídico real.
        </p>
        <button
          onClick={onContinuar}
          className="mt-5 px-5 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Entendi, ir para o login
        </button>
      </div>
    </div>
  );
}

function AvatarSelect({onChoose}){
  const [selected,setSelected] = useState(1);
  const avatars = [1,2,3,4,5,6];
  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white">
      <div className="max-w-xl w-full mx-4 p-6 rounded-3xl bg-slate-900 border border-white/10">
        <h2 className="text-2xl font-bold mb-2 text-center">Escolha seu avatar de Juiz</h2>
        <p className="text-xs opacity-80 mb-4 text-center">
          Essa imagem aparecerá no seu escritório, relatórios e sala de julgamento.
        </p>
        <div className="grid grid-cols-3 gap-3 mb-4">
          {avatars.map(i=>(
            <button
              key={i}
              onClick={()=>setSelected(i)}
              className={
                "aspect-square rounded-2xl overflow-hidden border " +
                (selected===i ? "border-emerald-400 ring-2 ring-emerald-500" : "border-white/20")
              }
            >
              <img src={IMG.avatar(i)} alt={`Avatar ${i}`} className="w-full h-full object-cover" />
            </button>
          ))}
        </div>
        <button
          onClick={()=>onChoose(selected)}
          className="w-full px-4 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Confirmar avatar
        </button>
      </div>
    </div>
  );
}

function LoginScreen({profiles,setProfiles,setCurrentProfile,onEnter}){
  const [user,setUser] = useState("");
  const [file,setFile] = useState(null);

  function saveProfiles(updated){
    setProfiles(updated);
    // Persistência de perfis na versão 6.3 Plus
    localStorage.setItem("juiz_profiles_v63",JSON.stringify(updated));
  }

  function handleEnter(){
    if(!user.trim()) return;
    const nome = user.trim();
    let updated = {...profiles};
    if(!updated[nome]){
      updated[nome] = {
        nome,
        court:null,
        estado:"SP",
        cidade:"São Paulo",
        // avatar null para forçar o usuário a escolher sua aparência no primeiro acesso
        avatar:null,
        stats:{julgados:0,acertos:0,condenacoes:0,absolvicoes:0,prestigio:0}
      };
      saveProfiles(updated);
    }
    setCurrentProfile(nome);
    onEnter(updated[nome]);
  }

  function handleExport(){
    const blob = new Blob([JSON.stringify(profiles,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "jogo-do-juiz-save.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function handleImport(){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        saveProfiles(data);
        alert("Save importado com sucesso!");
      }catch(err){
        alert("Arquivo inválido.");
      }
    };
    reader.readAsText(file);
  }

  return (
    <div
      className="min-h-screen flex items-center justify-center"
      style={{backgroundImage:`url('${IMG.capa}')`,backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="bg-black/80 text-white max-w-lg w-full mx-4 p-6 rounded-3xl border border-white/10 backdrop-blur">
        <h1 className="text-xl font-semibold mb-1 text-center">Vale Produção apresenta</h1>
        <h2 className="text-3xl font-bold text-center mb-4">Jogo do Juiz</h2>
        <p className="text-xs text-center mb-4 opacity-80">
          Crie seu usuário, exporte backups e volte quando quiser para continuar sua carreira.
        </p>

        <div className="space-y-3">
          <div>
            <label className="text-xs opacity-80">Usuário</label>
            <input
              className="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 outline-none text-sm"
              value={user}
              onChange={e=>setUser(e.target.value)}
              placeholder="Ex.: DraMaria, EstudanteJoão..."
            />
          </div>

          <div className="flex gap-2">
            <button
              onClick={handleEnter}
              className="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Entrar / Criar perfil
            </button>
            <button
              onClick={handleExport}
              className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
            >
              Exportar save
            </button>
          </div>

          <div className="mt-2 text-xs">
            <div className="mb-1">Importar save:</div>
            <input
              type="file"
              accept=".json"
              onChange={e=>setFile(e.target.files[0]||null)}
              className="text-xs"
            />
            <button
              onClick={handleImport}
              className="ml-2 px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs"
            >
              Importar
            </button>
          </div>
        </div>

        {Object.keys(profiles).length>0 && (
          <div className="mt-4">
            <div className="text-xs mb-1 opacity-70">Perfis salvos neste dispositivo:</div>
            <div className="flex flex-wrap gap-2">
              {Object.keys(profiles).map(p=>(
                <button
                  key={p}
                  onClick={()=>setUser(p)}
                  className="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 text-xs"
                >
                  {p}
                </button>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function CourtSelectScreen({onSelectCourt,profile}){
  // Lista de tribunais disponíveis. Na versão 6.3 Plus foram incluídos os ramos Civil, Tributário e Ambiental.
  const courts = [
    {id:"criminal",icon:"⚖️",nome:"Criminal",desc:"Crimes contra a pessoa e o patrimônio."},
    {id:"familia",icon:"👨‍👩‍👧",nome:"Família",desc:"Guarda, pensão, divórcio e medidas protetivas."},
    {id:"trabalhista",icon:"💼",nome:"Trabalhista",desc:"Vínculo, verbas, jornada e danos morais."},
    {id:"civil",icon:"📜",nome:"Civil",desc:"Contratos, responsabilidade civil e obrigações."},
    {id:"tributario",icon:"💰",nome:"Tributário",desc:"Execuções fiscais, autuações e imunidades."},
    {id:"ambiental",icon:"🌳",nome:"Ambiental",desc:"Infrações contra o meio ambiente e preservação."}
  ];
  return (
    <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white">
      <div className="max-w-4xl w-full mx-4 p-6">
        <h2 className="text-3xl font-bold mb-1 text-center">Bem-vindo, {profile.nome}</h2>
        <p className="text-xs opacity-80 mb-6 text-center">
          Escolha em qual ramo da Justiça você vai iniciar sua carreira de magistrado.
        </p>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {courts.map(c=>(
            <button
              key={c.id}
              onClick={()=>onSelectCourt(c.id)}
              className="p-5 rounded-3xl bg-slate-900 border border-white/15 hover:border-emerald-400 hover:-translate-y-1 transition text-left"
            >
              <div className="flex items-center gap-3 mb-2">
                <div className="text-3xl">{c.icon}</div>
                <div className="text-lg font-semibold">{c.nome}</div>
              </div>
              <p className="text-xs opacity-80 mt-1">{c.desc}</p>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

function LocationSelect({profile,onSelectLocation}){
  const [estado,setEstado] = useState(profile.estado||"SP");
  const cidades = ESTADOS[estado] || [];
  const [cidade,setCidade] = useState(profile.cidade||cidades[0]||"");

  return (
    <div className="min-h-screen bg-slate-950 text-white flex items-center justify-center">
      <div className="bg-slate-900 p-6 rounded-3xl max-w-md w-full mx-4 border border-white/10">
        <h2 className="text-2xl font-bold mb-1">Escolha a comarca</h2>
        <p className="text-xs opacity-80 mb-4">
          Esta informação aparecerá no cabeçalho do seu escritório e dos relatórios.
        </p>
        <div className="mb-3">
          <label className="text-xs opacity-80">Estado</label>
          <select
            value={estado}
            onChange={e=>{
              const uf = e.target.value;
              setEstado(uf);
              const lista = ESTADOS[uf]||[];
              setCidade(lista[0]||"");
            }}
            className="w-full mt-1 px-3 py-2 bg-slate-800 rounded-xl outline-none text-sm"
          >
            {Object.keys(ESTADOS).map(uf=>(
              <option key={uf} value={uf}>{uf}</option>
            ))}
          </select>
        </div>
        <div className="mb-4">
          <label className="text-xs opacity-80">Cidade</label>
          <select
            value={cidade}
            onChange={e=>setCidade(e.target.value)}
            className="w-full mt-1 px-3 py-2 bg-slate-800 rounded-xl outline-none text-sm"
          >
            {(ESTADOS[estado]||[]).map(c=>(
              <option key={c} value={c}>{c}</option>
            ))}
          </select>
        </div>
        <button
          onClick={()=>onSelectLocation(estado,cidade)}
          className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Confirmar
        </button>
      </div>
    </div>
  );
}

function ProvaViewer({tipo,conteudo,onClose}){
  if(!tipo) return null;
  const bgImg = tipo==="bo" ? IMG.bo : IMG.laudo;
  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-40">
      <div
        className="relative w-full max-w-xl rounded-3xl overflow-hidden border border-white/15 shadow-2xl"
        style={{backgroundImage:`url('${bgImg}')`,backgroundSize:"cover",backgroundPosition:"center"}}
      >
        <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" />
        <div className="relative z-10 p-6 text-white">
          <h3 className="text-lg font-semibold mb-2 uppercase">
            {tipo==="bo" ? "Boletim de Ocorrência" : "Laudo / Perícia"}
          </h3>
          <p className="text-sm whitespace-pre-wrap opacity-90 mb-4">{conteudo}</p>
          <button
            onClick={onClose}
            className="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-sm font-semibold"
          >
            Fechar documento
          </button>
        </div>
      </div>
    </div>
  );
}

function RelatorioModal({profile,onClose}){
  if(!profile) return null;
  const s = profile.stats || {};
  const julgados = s.julgados||0;
  const taxaAcerto = julgados>0 ? Math.round((s.acertos||0)*100/julgados) : 0;
  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-40">
      <div className="bg-slate-900 border border-emerald-400/40 rounded-3xl max-w-lg w-full mx-4 p-6 text-white">
        <div className="flex items-center gap-4 mb-4">
          <div className="w-16 h-16 rounded-2xl overflow-hidden border border-emerald-400/60">
            <img
              src={IMG.avatar(profile.avatar||1)}
              alt="Avatar juiz"
              className="w-full h-full object-cover"
            />
          </div>
          <div>
            <h2 className="text-xl font-bold">Relatório Trimestral</h2>
            <p className="text-xs opacity-80">
              Juiz(a) {profile.nome} – {profile.cidade}/{profile.estado}
            </p>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-3 text-sm mb-4">
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-xs opacity-70">Casos julgados</div>
            <div className="text-lg font-semibold">{julgados}</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-xs opacity-70">Taxa de acerto</div>
            <div className="text-lg font-semibold">{taxaAcerto}%</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-xs opacity-70">Condenações</div>
            <div className="text-lg font-semibold">{s.condenacoes||0}</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-xs opacity-70">Absolvições</div>
            <div className="text-lg font-semibold">{s.absolvicoes||0}</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3 col-span-2">
            <div className="text-xs opacity-70">Prestígio</div>
            <div className="text-lg font-semibold">{s.prestigio||0} pts</div>
          </div>
        </div>
        <p className="text-xs opacity-80 mb-4">
          Use esse relatório como ferramenta de estudo: observe se você está condenando demais,
          absolvendo demais ou mantendo um equilíbrio coerente com as provas apresentadas.
        </p>
        <button
          onClick={onClose}
          className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Fechar relatório
        </button>
      </div>
    </div>
  );
}

function Escritorio({profile,cases,onSelectCase,onSTJ,onShowRelatorio,sons,onChangeAvatar}){
  const fila = cases.filter(c=>c.status==="na_fila" && (profile.court==="stj" ? c.tipo==="stj" : c.tipo===profile.court));
  return (
    <div
      className="min-h-screen relative text-white"
      style={{backgroundImage:`url('${IMG.escritorio}')`,backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
      <div className="relative z-10 max-w-6xl mx-auto p-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-2xl overflow-hidden border border-emerald-400/60">
              <img
                src={IMG.avatar(profile.avatar||1)}
                alt="Avatar juiz"
                className="w-full h-full object-cover"
              />
            </div>
            <div>
              <h1 className="text-2xl font-bold">Escritório do Juiz</h1>
              <p className="text-xs opacity-80">
                {profile.nome} — {profile.cidade}/{profile.estado} • {profile.court==="stj"?"Ministro(a) do STJ":"Vara " + (profile.court||"não definida")}
              </p>
            </div>
          </div>
          <div className="text-xs text-right opacity-80">
            Julgados: {profile.stats?.julgados||0}<br/>
            Acertos: {profile.stats?.acertos||0}<br/>
            Prestígio: {profile.stats?.prestigio||0}
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-slate-900/90 border border-white/10 rounded-3xl p-5">
            <h2 className="text-lg font-semibold mb-3">Fila de processos</h2>
            <div className="max-h-96 overflow-y-auto space-y-3 pr-2">
              {fila.length===0 && (
                <p className="text-xs opacity-70">Nenhum processo na fila para este tribunal.</p>
              )}
              {fila.map(c=>(
                <div key={c.id} className="p-3 rounded-2xl bg-white/5 border border-white/10">
                  <h3 className="text-sm font-semibold mb-1">{c.titulo}</h3>
                  <p className="text-xs opacity-80 mb-2">Nível: {c.dificuldade} • Tipo: {c.tipo}</p>
                  <p className="text-xs opacity-70 mb-2 line-clamp-2">{c.resumo}</p>
                  <button
                    onClick={()=>{sons.gavel.play();onSelectCase(c.id);}}
                    className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                  >
                    Julgar agora
                  </button>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-slate-900/90 border border-white/10 rounded-3xl p-5 flex flex-col">
            <h2 className="text-lg font-semibold mb-3">Painel da carreira</h2>
            <p className="text-xs opacity-80 mb-3">
              Acompanhe sua evolução, acesse relatórios e, quando estiver pronto, candidate-se ao STJ.
            </p>
            <button
              onClick={onShowRelatorio}
              className="mb-2 w-full px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm font-semibold"
            >
              Ver relatório trimestral
            </button>
            {profile.court!=="stj" && (
              <button
                onClick={onSTJ}
                className="w-full px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-sm font-semibold mt-2"
              >
                Candidatar-se ao STJ
              </button>
            )}
            {/* Novo botão para troca de avatar */}
            <button
              onClick={onChangeAvatar}
              className="w-full px-4 py-2 rounded-xl bg-purple-500 hover:bg-purple-600 text-sm font-semibold mt-2"
            >
              Trocar avatar
            </button>
            <div className="mt-4 text-[10px] opacity-70">
              Simulação educacional inspirada em rotinas reais, sem valor jurídico. Ideal para cursos de Direito,
              concursos e treinamento de raciocínio jurídico.
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function JuryGrid({tipoCaso,dificuldade,prestigio,onDeliberar,vereditoFinal}){
  const [resultado,setResultado] = useState(null);

  function iniciar(){
    // Apenas processos criminais possuem júri popular
    if(tipoCaso!=="criminal"){
      alert("Neste tipo de processo (família, civil, trabalhista, tributário, ambiental ou STJ) não há júri popular. A decisão é exclusiva do juiz.");
      return;
    }
    // Determina probabilidade de condenação a partir da dificuldade e do prestígio do juiz
    let baseProb = 0.5;
    if(dificuldade === "alta") baseProb = 0.35;
    if(dificuldade === "baixa") baseProb = 0.65;
    const prestigeBonus = (prestigio || 0) / 100 * 0.3;
    const probCulpado = Math.min(0.9, Math.max(0.1, baseProb + prestigeBonus));
    let votosCulpado = 0;
    let votosInocente = 0;
    JURY_AVATARS.forEach(() => {
      const voto = Math.random() < probCulpado ? "culpado" : "inocente";
      if(voto === "culpado") votosCulpado++; else votosInocente++;
    });
    const vencedor = votosCulpado>votosInocente ? "culpado" : "inocente";
    setResultado({votosCulpado,votosInocente,vencedor});
    if(onDeliberar) onDeliberar(vencedor === "culpado");
  }

  return (
    <div className="bg-slate-900/90 border border-white/10 rounded-3xl p-4 mt-4">
      <h3 className="text-sm font-semibold mb-2">Júri Popular</h3>
      <div className="grid grid-cols-6 gap-2 mb-3">
        {JURY_AVATARS.map((src,idx)=>(
          <div key={src} className="flex flex-col items-center">
            <div className="w-8 h-8 rounded-full overflow-hidden border border-white/40 mb-1">
              <img src={src} alt={`Jurad@ ${idx+1}`} className="w-full h-full object-cover" />
            </div>
            <span className="text-[9px] opacity-70">J{idx+1}</span>
          </div>
        ))}
      </div>
      <button
        onClick={iniciar}
        className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
      >
        Iniciar deliberação do júri
      </button>
      {resultado && (
        <p className="text-[11px] opacity-80 mt-2">
          Votos culpado: {resultado.votosCulpado} • Votos inocente: {resultado.votosInocente} •
          Resultado simbólico: <b>{resultado.vencedor==="culpado"?"tendência à condenação":"tendência à absolvição"}</b>.
        </p>
      )}
      {vereditoFinal!=null && (
        <p className="text-[11px] opacity-90 mt-1">
          Veredito do juiz nesta simulação: <b>{vereditoFinal?"Condenar":"Absolver"}</b>.
        </p>
      )}
    </div>
  );
}

function TypewriterText({text}){
  const [shown,setShown] = useState("");
  useEffect(()=>{
    let i = 0;
    const id = setInterval(()=>{
      setShown(text.slice(0,i));
      i++;
      if(i>text.length) clearInterval(id);
    },18);
    return ()=>clearInterval(id);
  },[text]);
  return <p className="typewriter text-sm opacity-90">{shown}</p>;
}

function Julgamento({caso,onVoltar,onDecisao,profile,sons}){
  const [falas,setFalas] = useState([]);
  const [pergunta,setPergunta] = useState("");
  const [docAberto,setDocAberto] = useState(null);
  const [vereditoFinal,setVereditoFinal] = useState(null);

  async function ouvir(ag){
    const fala = await iaFala(ag,caso,"");
    setFalas(f=>[...f,{autor:ag,texto:fala}]);
    sons.murmur.play();
  }

  async function perguntarIA(){
    if(!pergunta.trim()) return;
    const fala = await iaFala("testemunha",caso,pergunta);
    setFalas(f=>[
      ...f,
      {autor:"juiz",texto:"PERGUNTA DO JUIZ: "+pergunta},
      {autor:"testemunha",texto:fala}
    ]);
    setPergunta("");
    sons.murmur.play();
  }

  function decidir(decisao){
    sons.gavel.play();
    const acertou = decisao===caso.gabarito.culpado;
    setVereditoFinal(decisao);
    onDecisao(decisao,acertou,caso);
    onVoltar();  // VOLTA PARA O ESCRITÓRIO APÓS DECISÃO (corrige "travamento")
  }

  function abrirDoc(tipo){
    if(!caso.docs) return;
    setDocAberto({tipo,conteudo: caso.docs[tipo]});
  }

  return (
    <div
      className="min-h-screen relative text-white"
      style={{backgroundImage:`url('${IMG.sala}')`,backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="absolute inset-0 bg-black/75 backdrop-blur-sm"></div>
      {docAberto && (
        <ProvaViewer
          tipo={docAberto.tipo}
          conteudo={docAberto.conteudo}
          onClose={()=>setDocAberto(null)}
        />
      )}
      <div className="relative z-10 max-w-6xl mx-auto p-6">
        <button
          onClick={onVoltar}
          className="mb-4 px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
        >
          Voltar ao escritório
        </button>

        <div className="flex items-center gap-3 mb-2">
          <div className="w-12 h-12 rounded-2xl overflow-hidden border border-emerald-400/60">
            <img src={IMG.avatar(profile.avatar||1)} alt="Juiz" className="w-full h-full object-cover" />
          </div>
          <div>
            <h1 className="text-xl font-bold">Sala de Julgamento</h1>
            <p className="text-xs opacity-80">
              Julgando: {caso.titulo} • {caso.tipo.toUpperCase()} • Nível {caso.dificuldade}
            </p>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-3">
          <div className="lg:col-span-2 space-y-3">
            <div className="bg-slate-900/90 rounded-3xl border border-white/10 p-4">
              <h2 className="text-sm font-semibold mb-1">Audiência</h2>

              <div className="flex items-center gap-2 mb-2 flex-wrap">
                <div className="flex items-center gap-1">
                  <div className="w-8 h-8 rounded-full overflow-hidden border border-red-400/70">
                    <img src={IMG.promotor} alt="Promotor" className="w-full h-full object-cover" />
                  </div>
                  <button
                    onClick={()=>ouvir("acusacao")}
                    className="px-3 py-1 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold"
                  >
                    Ouvir acusação
                  </button>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-8 h-8 rounded-full overflow-hidden border border-emerald-400/70">
                    <img src={IMG.defesa} alt="Defesa" className="w-full h-full object-cover" />
                  </div>
                  <button
                    onClick={()=>ouvir("defesa")}
                    className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                  >
                    Ouvir defesa
                  </button>
                </div>
                <div className="flex items-center gap-1">
                  <div className="w-8 h-8 rounded-full overflow-hidden border border-sky-400/70">
                    <img src={IMG.testemunha} alt="Testemunha" className="w-full h-full object-cover" />
                  </div>
                  <button
                    onClick={()=>ouvir("testemunha")}
                    className="px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold"
                  >
                    Ouvir testemunha
                  </button>
                </div>
              </div>

              <div className="space-y-2 max-h-56 overflow-y-auto pr-1">
                {falas.length===0 && (
                  <p className="text-xs opacity-70">
                    Use os botões acima para ouvir a acusação, a defesa e a testemunha. As falas aparecem abaixo,
                    com efeito de máquina de escrever.
                  </p>
                )}
                {falas.map((f,idx)=>(
                  <div key={idx} className="text-xs">
                    <TypewriterText text={f.texto} />
                  </div>
                ))}
              </div>

              <div className="mt-3 flex gap-2">
                <input
                  className="flex-1 px-3 py-2 rounded-xl bg-slate-800 text-xs outline-none"
                  placeholder="Pergunta do juiz para a testemunha..."
                  value={pergunta}
                  onChange={e=>setPergunta(e.target.value)}
                  onKeyDown={e=>{if(e.key==="Enter") perguntarIA();}}
                />
                <button
                  onClick={perguntarIA}
                  className="px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold"
                >
                  Perguntar
                </button>
              </div>
            </div>

            <JuryGrid
              tipoCaso={caso.tipo}
              dificuldade={caso.dificuldade}
              prestigio={profile.stats?.prestigio || 0}
              onDeliberar={()=>{}}
              vereditoFinal={vereditoFinal}
            />
          </div>

          <div className="space-y-3">
            <div className="bg-slate-900/90 rounded-3xl border border-white/10 p-4">
              <h2 className="text-sm font-semibold mb-2">Dossiê (Provas)</h2>
              <div className="space-y-2 text-xs">
                <button
                  onClick={()=>abrirDoc("bo")}
                  className="w-full px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left"
                >
                  📄 Boletim de ocorrência
                </button>
                <button
                  onClick={()=>abrirDoc("laudo")}
                  className="w-full px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left"
                >
                  🔬 Laudo pericial
                </button>
                <button
                  onClick={()=>abrirDoc("pericia")}
                  className="w-full px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left"
                >
                  🧪 Perícia complementar
                </button>
              </div>
            </div>

            <div className="bg-slate-900/90 rounded-3xl border border-white/10 p-4">
              <h2 className="text-sm font-semibold mb-2">Veredito do Juiz</h2>
              <p className="text-[11px] opacity-80 mb-3">
                Após analisar as provas e ouvir as partes, decida se o réu deve ser condenado ou absolvido.
                A simulação avalia se sua decisão é coerente com o gabarito pedagógico.
              </p>
              <div className="flex flex-col gap-2">
                <button
                  onClick={()=>decidir(true)}
                  className="px-3 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold"
                >
                  Condenar
                </button>
                <button
                  onClick={()=>decidir(false)}
                  className="px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                >
                  Absolver
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* -------------------- TELA EXAME STJ -------------------- */

const STJ_QUESTOES = [
  {
    enunciado:"O STJ julga, em regra, recursos especiais que discutem:",
    alternativas:[
      "Controvérsia sobre lei federal.",
      "Constitucionalidade de emenda constitucional.",
      "Criação de municípios.",
      "Crime de responsabilidade do Presidente."
    ],
    correta:0
  },
  {
    enunciado:"O julgamento colegiado no STJ é realizado, em regra:",
    alternativas:[
      "Pelo Plenário do STF.",
      "Por Turmas e Seções especializadas.",
      "Por júri popular.",
      "Por varas criminais de 1ª instância."
    ],
    correta:1
  },
  {
    enunciado:"A função do precedente qualificado é:",
    alternativas:[
      "Vincular decisões posteriores em casos semelhantes.",
      "Substituir completamente a lei escrita.",
      "Apenas servir como orientação sem qualquer efeito.",
      "Criar competência originária do STJ."
    ],
    correta:0
  },
  {
    enunciado:"Em recursos especiais repetitivos, o STJ busca:",
    alternativas:[
      "Analisar apenas um caso sem impacto nos demais.",
      "Uniformizar a interpretação da lei federal.",
      "Julgar exclusivamente matérias constitucionais.",
      "Atuar como tribunal de 1ª instância."
    ],
    correta:1
  },
  {
    enunciado:"Sobre a atuação do relator no STJ, é correto afirmar que:",
    alternativas:[
      "Pode decidir monocraticamente alguns recursos.",
      "Não pode jamais decidir sozinho.",
      "É obrigado a ouvir o júri popular.",
      "Julga apenas processos criminais."
    ],
    correta:0
  }
];

function STJExam({profile,onFinish}){
  const [respostas,setRespostas] = useState({});
  const [enviado,setEnviado] = useState(false);

  function toggle(qIdx,altIdx){
    if(enviado) return;
    setRespostas(r=>({...r,[qIdx]:altIdx}));
  }

  function corrigir(){
    let acertos = 0;
    STJ_QUESTOES.forEach((q,idx)=>{
      if(respostas[idx]===q.correta) acertos++;
    });
    setEnviado(true);
    const aprovado = acertos>=4;
    onFinish(aprovado,acertos);
  }

  return (
    <div
      className="min-h-screen flex items-center justify-center text-white"
      style={{backgroundImage:`url('${IMG.stj}')`,backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="bg-black/80 max-w-3xl w-full mx-4 p-6 rounded-3xl border border-yellow-400/60 backdrop-blur">
        <h2 className="text-2xl font-bold mb-1 text-center">Prova Rápida – STJ</h2>
        <p className="text-xs opacity-80 mb-4 text-center">
          Juiz(a) {profile.nome}, responda às questões abaixo sobre funcionamento do STJ.
          É necessário acertar pelo menos 4 para ser promovido.
        </p>

        <div className="max-h-[60vh] overflow-y-auto pr-2 space-y-4 text-xs">
          {STJ_QUESTOES.map((q,idx)=>(
            <div key={idx} className="bg-white/5 rounded-2xl p-3">
              <p className="font-semibold mb-2">{idx+1}. {q.enunciado}</p>
              <div className="space-y-1">
                {q.alternativas.map((alt,aIdx)=>(
                  <label key={aIdx} className="flex items-start gap-2 cursor-pointer">
                    <input
                      type="radio"
                      className="mt-0.5"
                      checked={respostas[idx]===aIdx}
                      onChange={()=>toggle(idx,aIdx)}
                      disabled={enviado}
                    />
                    <span>{alt}</span>
                  </label>
                ))}
              </div>
            </div>
          ))}
        </div>

        {!enviado && (
          <button
            onClick={corrigir}
            className="mt-4 w-full px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-sm font-semibold"
          >
            Enviar prova
          </button>
        )}
      </div>
    </div>
  );
}

/* -------------------- APP PRINCIPAL -------------------- */

function App(){
  const [screen,setScreen] = useState("splash");
  const [profiles,setProfiles] = useState(()=>{
    // Carrega perfis salvos (versão 6.3 Plus usa chave juiz_profiles_v63)
    try{
      return JSON.parse(localStorage.getItem("juiz_profiles_v63")||"{}");
    }catch(e){return {};}
  });
  const [currentProfileId,setCurrentProfileId] = useState(null);
  const [cases,setCases] = useState(()=>{
    // Tenta carregar casos salvos; caso contrário, gera nova lista e persiste
    try{
      const saved = JSON.parse(localStorage.getItem("juiz_cases_v63")||"[]");
      if(Array.isArray(saved) && saved.length>0){
        return saved;
      }
    }catch(e){}
    const seeded = seedCases();
    localStorage.setItem("juiz_cases_v63",JSON.stringify(seeded));
    return seeded;
  });
  const [currentCaseId,setCurrentCaseId] = useState(null);
  const [showRelatorio,setShowRelatorio] = useState(false);

  const sons = {
    gavel: useSound(SOUND_URLS.gavel,true,0.7),
    murmur: useSound(SOUND_URLS.murmur,true,0.5)
  };

  const currentProfile = currentProfileId ? profiles[currentProfileId] : null;
  const currentCase = currentCaseId ? cases.find(c=>c.id===currentCaseId) : null;

  function saveProfiles(updated){
    setProfiles(updated);
    localStorage.setItem("juiz_profiles_v63",JSON.stringify(updated));
  }

  function updateCurrentProfile(updater){
    if(!currentProfile) return;
    setProfiles(prev=>{
      const p = {...prev[currentProfileId]};
      updater(p);
      const next = {...prev,[currentProfileId]:p};
      // Atualiza armazenamento de perfis na chave da versão 6.3 Plus
      localStorage.setItem("juiz_profiles_v63",JSON.stringify(next));
      return next;
    });
  }

  // Persiste a lista de casos atualizada. Esta função deve ser utilizada sempre que um caso for modificado.
  function saveCases(updated){
    setCases(updated);
    localStorage.setItem("juiz_cases_v63",JSON.stringify(updated));
  }

  function handleSTJButton(){
    if(!currentProfile) return;
    const s = currentProfile.stats||{};
    if((s.prestigio||0) < 40 || (s.julgados||0) < 20){
      alert("Para se candidatar ao STJ é necessário, nesta simulação, ter pelo menos 20 casos julgados e 40 pontos de prestígio.");
      return;
    }
    setScreen("stj_exam");
  }

  function handleSTJFinish(aprovado,acertos){
    if(aprovado){
      updateCurrentProfile(p=>{
        p.court = "stj";
        p.stats.prestigio = (p.stats.prestigio||0) + 20;
      });
      alert("Parabéns! Você foi aprovado no exame do STJ com " + acertos + " acertos.");
      setScreen("office");
    }else{
      alert("Você acertou " + acertos + " questões. Nesta simulação, é necessário ao menos 4 para aprovação. Continue estudando!");
      setScreen("office");
    }
  }

  function onDecisaoCaso(decisao,acertou,caso){
    // Atualiza casos: calcula nova lista e persiste utilizando saveCases
    const atualizados = cases.map(c=>{
      if(c.id!==caso.id) return c;
      return {...c,status: decisao ? "condenado":"absolvido"};
    });
    saveCases(atualizados);
    // Atualiza estatísticas
    updateCurrentProfile(p=>{
      const s = p.stats||{};
      s.julgados = (s.julgados||0)+1;
      if(decisao) s.condenacoes = (s.condenacoes||0)+1;
      else s.absolvicoes = (s.absolvicoes||0)+1;
      if(acertou){
        s.acertos = (s.acertos||0)+1;
        s.prestigio = (s.prestigio||0)+3;
      }else{
        s.prestigio = Math.max(0,(s.prestigio||0)-2);
      }
      p.stats = s;
    });
    // Sai do caso atual (corrige travamento em Família/Trabalhista)
    setCurrentCaseId(null);
  }

  /* ----- ROTAS DE TELA ----- */

  if(screen==="splash"){
    return <SplashScreen onStart={()=>setScreen("tutorial")} />;
  }

  if(screen==="tutorial"){
    return <TutorialSalvamento onContinuar={()=>setScreen("login")} />;
  }

  if(screen==="login"){
    return (
      <LoginScreen
        profiles={profiles}
        setProfiles={setProfiles}
        setCurrentProfile={setCurrentProfileId}
        onEnter={(profile)=>{
          setCurrentProfileId(profile.nome);
          if(!profile.avatar){
            setScreen("avatar");
          }else if(!profile.court){
            setScreen("court");
          }else{
            setScreen("location");
          }
        }}
      />
    );
  }

  if(screen==="avatar" && currentProfile){
    return (
      <AvatarSelect
        onChoose={(idx)=>{
          updateCurrentProfile(p=>{p.avatar = idx;});
          setScreen("court");
        }}
      />
    );
  }

  // Seleção de avatar fora do fluxo de cadastro (troca manual no escritório)
  if(screen==="avatarChange" && currentProfile){
    return (
      <AvatarSelect
        onChoose={(idx)=>{
          updateCurrentProfile(p=>{p.avatar = idx;});
          setScreen("office");
        }}
      />
    );
  }

  if(screen==="court" && currentProfile){
    return (
      <CourtSelectScreen
        profile={currentProfile}
        onSelectCourt={(court)=>{
          updateCurrentProfile(p=>{p.court = court;});
          setScreen("location");
        }}
      />
    );
  }

  if(screen==="location" && currentProfile){
    return (
      <LocationSelect
        profile={currentProfile}
        onSelectLocation={(estado,cidade)=>{
          updateCurrentProfile(p=>{
            p.estado = estado;
            p.cidade = cidade;
          });
          setScreen("office");
        }}
      />
    );
  }

  if(screen==="office" && currentProfile){
    return (
      <>
        <Escritorio
          profile={currentProfile}
          cases={cases}
          onSelectCase={(id)=>{setCurrentCaseId(id);setScreen("trial");}}
          onSTJ={handleSTJButton}
          onShowRelatorio={()=>setShowRelatorio(true)}
          sons={sons}
          onChangeAvatar={()=>setScreen("avatarChange")}
        />
        {showRelatorio && (
          <RelatorioModal
            profile={currentProfile}
            onClose={()=>setShowRelatorio(false)}
          />
        )}
      </>
    );
  }

  if(screen==="trial" && currentProfile && currentCase){
    return (
      <Julgamento
        profile={currentProfile}
        caso={currentCase}
        onVoltar={()=>setScreen("office")}
        onDecisao={onDecisaoCaso}
        sons={sons}
      />
    );
  }

  if(screen==="stj_exam" && currentProfile){
    return (
      <STJExam
        profile={currentProfile}
        onFinish={handleSTJFinish}
      />
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white">
      <div className="text-center">
        <p>Carregando simulador...</p>
        <button
          className="mt-3 px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm"
          onClick={()=>setScreen("splash")}
        >
          Voltar ao início
        </button>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>

