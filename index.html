<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jogo do Juiz ‚Äì Vale Produ√ß√£o</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #root { height: 100%; }
    body {
      margin: 0;
      background: #020617;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    /* anima√ß√£o m√°quina de escrever */
    .typewriter {
      overflow: hidden;
      white-space: pre-wrap;
      border-right: .15em solid rgba(248,250,252,0.5);
      animation: caret 0.7s steps(1) infinite;
    }
    @keyframes caret {
      50% { border-color: transparent; }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* -------------------- DADOS FIXOS -------------------- */

const ESTADOS = {
  "AC":["Rio Branco"],"AL":["Macei√≥"],"AP":["Macap√°"],"AM":["Manaus"],
  "BA":["Salvador","Feira de Santana","Vit√≥ria da Conquista"],
  "CE":["Fortaleza"],"DF":["Bras√≠lia"],"ES":["Vit√≥ria"],"GO":["Goi√¢nia"],
  "MA":["S√£o Lu√≠s"],"MT":["Cuiab√°"],"MS":["Campo Grande"],
  "MG":["Belo Horizonte","Uberl√¢ndia","Juiz de Fora"],
  "PA":["Bel√©m"],"PB":["Jo√£o Pessoa"],"PR":["Curitiba","Londrina"],
  "PE":["Recife"],"PI":["Teresina"],"RJ":["Rio de Janeiro","Niter√≥i"],
  "RN":["Natal"],"RS":["Porto Alegre","Caxias do Sul"],
  "RO":["Porto Velho"],"RR":["Boa Vista"],
  "SC":["Florian√≥polis","Joinville"],
  "SP":["S√£o Paulo","Campinas","Santos","Sorocaba"],
  "SE":["Aracaju"],"TO":["Palmas"]
};

const JURY_AVATARS = Array.from({length:12},(_,i)=>`juri${i+1}.jpg`);

const SOUND_URLS = {
  gavel: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_b8e7f6b3a0.mp3?filename=judge-gavel-182004.mp3",
  murmur: "https://cdn.pixabay.com/download/audio/2021/09/16/audio_7b4b2d7f6c.mp3?filename=crowd-murmur-ambient-75537.mp3"
};

function useSound(url, enabled=true, volume=0.7){
  const ref = useRef(null);
  useEffect(()=>{
    const a = new Audio(url);
    a.volume = volume;
    ref.current = a;
    return ()=>{ a.pause(); ref.current = null; };
  },[url]);
  const play = ()=>{ if(enabled && ref.current){ ref.current.currentTime = 0; ref.current.play(); } };
  return { play };
}

/* -------------------- GERADOR DE CASOS -------------------- */

function makeDocs(titulo,resumo){
  return {
    bo: (
      "BOLETIM DE OCORR√äNCIA\n\n" +
      "T√≠tulo: " + titulo + "\n\n" +
      "S√≠ntese f√°tico-cronol√≥gica dos acontecimentos, com identifica√ß√£o das partes, " +
      "hor√°rio aproximado, local do fato e breve hist√≥rico da interven√ß√£o policial.\n\n" +
      "Resumo: " + resumo
    ),
    laudo: (
      "LAUDO PERICIAL / PER√çCIA COMPLEMENTAR\n\n" +
      "Objeto: an√°lise t√©cnica dos vest√≠gios materiais relacionados ao caso \"" + titulo + "\".\n\n" +
      "Constata√ß√µes: descrevem-se danos, marcas, registros de c√¢meras, exames m√©dicos, " +
      "documentos trabalhistas ou familiares, conforme a natureza da a√ß√£o.\n\n" +
      "Conclus√£o t√©cnica: avalia√ß√£o imparcial dos ind√≠cios sob o ponto de vista pericial.\n\n" +
      "Resumo do caso: " + resumo
    ),
    pericia: (
      "LAUDO PERICIAL COMPLEMENTAR\n\n" +
      "Este documento aprofunda pontos espec√≠ficos solicitados pelo Ju√≠zo ou pelas partes, " +
      "refor√ßando ou esclarecendo trechos do laudo principal.\n\n" +
      "Resumo do caso: " + resumo
    )
  };
}

function seedCases(){
  const casos = [];
  let id = 1;

  function addLote(tipo, baseTitulos, baseResumos, culpadoDefault, quantidade){
    for(let i=1;i<=quantidade;i++){
      const t = baseTitulos[(i-1)%baseTitulos.length];
      const r = baseResumos[(i-1)%baseResumos.length];
      const docs = makeDocs(t, r);
      casos.push({
        id: tipo.toUpperCase()+"-"+id++,
        tipo,
        titulo: t + " #" + i,
        resumo: r,
        dificuldade: (i%3===0?"alta": i%2===0?"m√©dia":"baixa"),
        gabarito:{culpado:culpadoDefault},
        status:"na_fila",
        docs
      });
    }
  }

  addLote("criminal",
    [
      "Homic√≠dio simples em briga de bar",
      "Roubo em transporte p√∫blico",
      "Furto qualificado em resid√™ncia",
      "Les√£o corporal em evento esportivo"
    ],
    [
      "Discuss√£o que evolui para agress√£o grave com resultado morte em estabelecimento lotado.",
      "Subtra√ß√£o de bens de passageiro mediante grave amea√ßa dentro de √¥nibus urbano.",
      "Invas√£o de resid√™ncia com arrombamento em per√≠odo noturno, com subtra√ß√£o de eletr√¥nicos.",
      "Conflito entre torcidas que resulta em les√µes m√∫ltiplas e diverg√™ncia entre vers√µes."
    ],
    true,
    40
  );

  addLote("familia",
    [
      "Revis√£o de pens√£o aliment√≠cia",
      "Defini√ß√£o de guarda compartilhada",
      "Regulamenta√ß√£o de visitas em outra cidade",
      "Medida protetiva por viol√™ncia dom√©stica"
    ],
    [
      "Altera√ß√£o do valor de pens√£o em raz√£o de mudan√ßa significativa de renda do alimentante.",
      "Fixa√ß√£o de regime de conviv√™ncia equilibrado entre genitores e filho menor.",
      "Organiza√ß√£o de calend√°rio de visitas diante da mudan√ßa de domic√≠lio de um dos genitores.",
      "Pedido de prote√ß√£o urgente diante de hist√≥rico de agress√µes e amea√ßas."
    ],
    false,
    40
  );

  addLote("trabalhista",
    [
      "Horas extras habituais sem registro",
      "Reconhecimento de v√≠nculo de emprego",
      "Ass√©dio moral em ambiente de trabalho",
      "Acidente t√≠pico com afastamento prolongado"
    ],
    [
      "Empregado alega jornadas di√°rias superiores ao contrato sem correta remunera√ß√£o.",
      "Trabalhador formalmente PJ busca reconhecimento de v√≠nculo empregat√≠cio.",
      "Relatos de humilha√ß√µes reiteradas por superior hier√°rquico diante de colegas.",
      "Queda em servi√ßo com sequelas e discuss√£o sobre responsabilidade do empregador."
    ],
    false,
    40
  );

  addLote("stj",
    [
      "Recurso especial em mat√©ria criminal",
      "Recurso especial em direito de fam√≠lia",
      "Recurso especial em direito do trabalho",
      "Recurso especial sobre compet√™ncia"
    ],
    [
      "Discuss√£o sobre interpreta√ß√£o de norma federal em precedente criminal relevante.",
      "Diverg√™ncia entre tribunais acerca de partilha e alimentos.",
      "Uniformiza√ß√£o de entendimento sobre verbas trabalhistas de natureza indenizat√≥ria.",
      "Defini√ß√£o de qual justi√ßa √© competente para julgar o caso concreto."
    ],
    false,
    40
  );

  return casos;
}

/* -------------------- IA SIMULADA -------------------- */

async function iaFala(agente, caso, pergunta=""){
  const prefixo =
    agente==="acusacao" ? "PROMOTOR: " :
    agente==="defesa" ? "DEFESA: " :
    "TESTEMUNHA: ";

  const focoPergunta = pergunta
    ? `Respondendo √† pergunta do Juiz: "${pergunta}". `
    : "";

  let corpo;
  if(agente==="acusacao"){
    corpo =
      "A acusa√ß√£o sustenta que o conjunto das provas, especialmente documentos e depoimentos constantes dos autos, " +
      "aponta para a responsabilidade do r√©u, observando o padr√£o de prova exigido para a condena√ß√£o. ";
  } else if(agente==="defesa"){
    corpo =
      "A defesa destaca as lacunas probat√≥rias, eventuais contradi√ß√µes e a necessidade de se preservar a presun√ß√£o de inoc√™ncia, " +
      "valorizando interpreta√ß√µes que favore√ßam a d√∫vida razo√°vel. ";
  } else {
    corpo =
      "Eu, enquanto testemunha, narro em primeira pessoa o que presenciei: descrevo o ambiente, as pessoas envolvidas " +
      "e a sequ√™ncia dos fatos sem emitir ju√≠zo de valor jur√≠dico, apenas relatando o que meus sentidos alcan√ßaram. ";
  }

  const resumo = "Resumo do caso: " + caso.resumo;

  const texto = prefixo + focoPergunta + corpo + resumo;

  await new Promise(r=>setTimeout(r,400));
  return texto;
}

/* -------------------- COMPONENTES -------------------- */

function SplashScreen({onStart}){
  return (
    <div className="min-h-screen flex items-center justify-center bg-black">
      <div
        className="relative w-full max-w-md h-[520px] rounded-3xl overflow-hidden shadow-2xl"
        style={{backgroundImage:"url('capa.jpg')", backgroundSize:"cover", backgroundPosition:"center"}}
      >
        <div className="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent" />
        <div className="relative z-10 h-full flex flex-col items-center justify-end pb-10 px-6 text-white">
          <h1 className="text-3xl font-bold mb-1 drop-shadow-lg text-center">Tribunal</h1>
          <p className="text-lg font-semibold mb-2 drop-shadow-lg text-center">Simulador de Juiz</p>
          <p className="text-xs opacity-90 mb-4 text-center">Vale Produ√ß√£o ‚Ä¢ Vers√£o 7.0</p>
          <button
            onClick={onStart}
            className="px-6 py-3 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold shadow-xl"
          >
            Iniciar
          </button>
        </div>
      </div>
    </div>
  );
}

function TutorialSalvamento({onContinuar}){
  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white">
      <div className="max-w-xl w-full mx-4 p-6 rounded-3xl bg-slate-900 border border-white/10 shadow-xl">
        <h2 className="text-2xl font-bold mb-3">Como o jogo salva seu progresso</h2>
        <ol className="list-decimal pl-5 space-y-2 text-sm">
          <li>Seu perfil √© salvo automaticamente neste navegador (localStorage).</li>
          <li>Na tela de login voc√™ pode <b>Exportar</b> um arquivo de backup <code>.json</code>.</li>
          <li>Em qualquer outro dispositivo, use <b>Importar</b> para continuar exatamente do ponto em que parou.</li>
          <li>Use sempre o mesmo nome de usu√°rio para manter a sua carreira organizada.</li>
        </ol>
        <p className="mt-4 text-xs opacity-80">
          Importante: por ser um simulador educacional, nenhuma decis√£o aqui tem efeito jur√≠dico real.
        </p>
        <button
          onClick={onContinuar}
          className="mt-5 px-5 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Entendi, ir para o login
        </button>
      </div>
    </div>
  );
}

function AvatarSelect({onChoose}){
  const [selected,setSelected] = useState(1);
  const avatars = [1,2,3,4,5,6];
  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white">
      <div className="max-w-xl w-full mx-4 p-6 rounded-3xl bg-slate-900 border border-white/10">
        <h2 className="text-2xl font-bold mb-2 text-center">Escolha seu avatar de Juiz</h2>
        <p className="text-xs opacity-80 mb-4 text-center">
          Essa imagem aparecer√° no seu escrit√≥rio, na tela de relat√≥rio e em outras partes do simulador.
        </p>
        <div className="grid grid-cols-3 gap-3 mb-4">
          {avatars.map(i=>(
            <button
              key={i}
              onClick={()=>setSelected(i)}
              className={
                "aspect-square rounded-2xl overflow-hidden border " +
                (selected===i ? "border-emerald-400 ring-2 ring-emerald-500" : "border-white/20")
              }
            >
              <img src={`avatar${i}.jpg`} alt={`Avatar ${i}`} className="w-full h-full object-cover" />
            </button>
          ))}
        </div>
        <button
          onClick={()=>onChoose(selected)}
          className="w-full px-4 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Confirmar avatar
        </button>
      </div>
    </div>
  );
}

function LoginScreen({profiles,setProfiles,setCurrentProfile,onEnter}){
  const [user,setUser] = useState("");
  const [file,setFile] = useState(null);

  function saveProfiles(updated){
    setProfiles(updated);
    localStorage.setItem("juiz_profiles_v7",JSON.stringify(updated));
  }

  function handleEnter(){
    if(!user.trim()) return;
    const nome = user.trim();
    let updated = {...profiles};
    if(!updated[nome]){
      updated[nome] = {
        nome,
        court:null,
        estado:"SP",
        cidade:"S√£o Paulo",
        avatar:1,
        stats:{julgados:0,acertos:0,condenacoes:0,absolvicoes:0,prestigio:0}
      };
      saveProfiles(updated);
    }
    setCurrentProfile(nome);
    onEnter(updated[nome]);
  }

  function handleExport(){
    const blob = new Blob([JSON.stringify(profiles,null,2)],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "jogo-do-juiz-save.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function handleImport(){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        saveProfiles(data);
        alert("Save importado com sucesso!");
      }catch(err){
        alert("Arquivo inv√°lido.");
      }
    };
    reader.readAsText(file);
  }

  return (
    <div
      className="min-h-screen flex items-center justify-center"
      style={{backgroundImage:"url('capa.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="bg-black/80 text-white max-w-lg w-full mx-4 p-6 rounded-3xl border border-white/10 backdrop-blur">
        <h1 className="text-xl font-semibold mb-1 text-center">Vale Produ√ß√£o apresenta</h1>
        <h2 className="text-3xl font-bold text-center mb-4">Jogo do Juiz</h2>
        <p className="text-xs text-center mb-4 opacity-80">
          Crie seu usu√°rio, exporte backups e volte quando quiser para continuar sua carreira.
        </p>

        <div className="space-y-3">
          <div>
            <label className="text-xs opacity-80">Usu√°rio</label>
            <input
              className="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 outline-none text-sm"
              value={user}
              onChange={e=>setUser(e.target.value)}
              placeholder="Ex.: DraMaria, EstudanteJo√£o..."
            />
          </div>

          <div className="flex gap-2">
            <button
              onClick={handleEnter}
              className="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Entrar / Criar perfil
            </button>
            <button
              onClick={handleExport}
              className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
            >
              Exportar save
            </button>
          </div>

          <div className="mt-2 text-xs">
            <div className="mb-1">Importar save:</div>
            <input
              type="file"
              accept=".json"
              onChange={e=>setFile(e.target.files[0]||null)}
              className="text-xs"
            />
            <button
              onClick={handleImport}
              className="ml-2 px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs"
            >
              Importar
            </button>
          </div>
        </div>

        {Object.keys(profiles).length>0 && (
          <div className="mt-4">
            <div className="text-xs mb-1 opacity-70">Perfis salvos neste dispositivo:</div>
            <div className="flex flex-wrap gap-2">
              {Object.keys(profiles).map(p=>(
                <button
                  key={p}
                  onClick={()=>setUser(p)}
                  className="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 text-xs"
                >
                  {p}
                </button>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function CourtSelectScreen({onSelectCourt,profile}){
  const courts = [
    {id:"criminal",icon:"‚öñÔ∏è",nome:"Criminal",desc:"Crimes contra a pessoa e o patrim√¥nio."},
    {id:"familia",icon:"üë®‚Äçüë©‚Äçüëß",nome:"Fam√≠lia",desc:"Guarda, pens√£o, div√≥rcio e medidas protetivas."},
    {id:"trabalhista",icon:"üíº",nome:"Trabalhista",desc:"V√≠nculo, verbas, jornada e danos morais."}
  ];
  return (
    <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white">
      <div className="max-w-4xl w-full mx-4 p-6">
        <h2 className="text-3xl font-bold mb-1 text-center">Bem-vindo, {profile.nome}</h2>
        <p className="text-xs opacity-80 mb-6 text-center">
          Escolha em qual ramo da Justi√ßa voc√™ vai iniciar sua carreira de magistrado.
        </p>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {courts.map(c=>(
            <button
              key={c.id}
              onClick={()=>onSelectCourt(c.id)}
              className="p-5 rounded-3xl bg-slate-900 border border-white/15 hover:border-emerald-400 hover:-translate-y-1 transition text-left"
            >
              <div className="flex items-center gap-3 mb-2">
                <div className="text-3xl">{c.icon}</div>
                <div className="text-lg font-semibold">{c.nome}</div>
              </div>
              <p className="text-xs opacity-80 mt-1">{c.desc}</p>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

function LocationSelect({profile,onSelectLocation}){
  const [estado,setEstado] = useState(profile.estado||"SP");
  const cidades = ESTADOS[estado] || [];
  const [cidade,setCidade] = useState(profile.cidade||cidades[0]||"");

  return (
    <div className="min-h-screen bg-slate-950 text-white flex items-center justify-center">
      <div className="bg-slate-900 p-6 rounded-3xl max-w-md w-full mx-4 border border-white/10">
        <h2 className="text-2xl font-bold mb-1">Escolha a comarca</h2>
        <p className="text-xs opacity-80 mb-4">
          Esta informa√ß√£o aparecer√° no cabe√ßalho do seu escrit√≥rio e dos relat√≥rios.
        </p>
        <div className="mb-3">
          <label className="text-xs opacity-80">Estado</label>
          <select
            value={estado}
            onChange={e=>{
              const uf = e.target.value;
              setEstado(uf);
              const lista = ESTADOS[uf]||[];
              setCidade(lista[0]||"");
            }}
            className="w-full mt-1 px-3 py-2 bg-slate-800 rounded-xl outline-none text-sm"
          >
            {Object.keys(ESTADOS).map(uf=>(
              <option key={uf} value={uf}>{uf}</option>
            ))}
          </select>
        </div>
        <div className="mb-4">
          <label className="text-xs opacity-80">Cidade</label>
          <select
            value={cidade}
            onChange={e=>setCidade(e.target.value)}
            className="w-full mt-1 px-3 py-2 bg-slate-800 rounded-xl outline-none text-sm"
          >
            {(ESTADOS[estado]||[]).map(c=>(
              <option key={c} value={c}>{c}</option>
            ))}
          </select>
        </div>
        <button
          onClick={()=>onSelectLocation(estado,cidade)}
          className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Confirmar
        </button>
      </div>
    </div>
  );
}

function ProvaViewer({tipo,conteudo,onClose}){
  if(!tipo) return null;
  const bgImg = tipo==="bo" ? "bo.jpg" : "laudo.jpg";
  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-40">
      <div
        className="relative w-full max-w-xl rounded-3xl overflow-hidden border border-white/15 shadow-2xl"
        style={{backgroundImage:`url('${bgImg}')`,backgroundSize:"cover",backgroundPosition:"center"}}
      >
        <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" />
        <div className="relative z-10 p-6 text-white">
          <h3 className="text-lg font-semibold mb-2 uppercase">
            {tipo==="bo" ? "Boletim de Ocorr√™ncia" : "Laudo / Per√≠cia"}
          </h3>
          <p className="text-sm whitespace-pre-wrap opacity-90 mb-4">{conteudo}</p>
          <button
            onClick={onClose}
            className="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-sm font-semibold"
          >
            Fechar documento
          </button>
        </div>
      </div>
    </div>
  );
}

function RelatorioModal({profile,onClose}){
  if(!profile) return null;
  const s = profile.stats || {};
  const julgados = s.julgados||0;
  const taxaAcerto = julgados>0 ? Math.round((s.acertos||0)*100/julgados) : 0;
  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-40">
      <div className="bg-slate-900 border border-emerald-400/40 rounded-3xl max-w-lg w-full mx-4 p-6 text-white">
        <div className="flex items-center gap-4 mb-4">
          <div className="w-16 h-16 rounded-2xl overflow-hidden border border-emerald-400/60">
            <img
              src={`avatar${profile.avatar||1}.jpg`}
              alt="Avatar juiz"
              className="w-full h-full object-cover"
            />
          </div>
          <div>
            <h2 className="text-xl font-bold">Relat√≥rio Trimestral</h2>
            <p className="text-xs opacity-80">
              Juiz(a) {profile.nome} ‚Äì {profile.cidade}/{profile.estado}
            </p>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-3 text-sm mb-4">
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-xs opacity-70">Casos julgados</div>
            <div className="text-lg font-semibold">{julgados}</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-xs opacity-70">Taxa de acerto</div>
            <div className="text-lg font-semibold">{taxaAcerto}%</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-xs opacity-70">Condena√ß√µes</div>
            <div className="text-lg font-semibold">{s.condenacoes||0}</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3">
            <div className="text-xs opacity-70">Absolvi√ß√µes</div>
            <div className="text-lg font-semibold">{s.absolvicoes||0}</div>
          </div>
          <div className="bg-white/5 rounded-2xl p-3 col-span-2">
            <div className="text-xs opacity-70">Prest√≠gio</div>
            <div className="text-lg font-semibold">{s.prestigio||0} pts</div>
          </div>
        </div>
        <p className="text-xs opacity-80 mb-4">
          Use esse relat√≥rio como ferramenta de estudo: observe se voc√™ est√° condenando demais,
          absolvendo demais ou mantendo um equil√≠brio coerente com as provas apresentadas.
        </p>
        <button
          onClick={onClose}
          className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
        >
          Fechar relat√≥rio
        </button>
      </div>
    </div>
  );
}

function Escritorio({profile,cases,onSelectCase,onSTJ,onShowRelatorio,sons}){
  const fila = cases.filter(c=>c.status==="na_fila" && c.tipo===profile.court);
  return (
    <div
      className="min-h-screen relative text-white"
      style={{backgroundImage:"url('escritorio.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
      <div className="relative z-10 max-w-6xl mx-auto p-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-2xl overflow-hidden border border-emerald-400/60">
              <img
                src={`avatar${profile.avatar||1}.jpg`}
                alt="Avatar juiz"
                className="w-full h-full object-cover"
              />
            </div>
            <div>
              <h1 className="text-2xl font-bold">Escrit√≥rio do Juiz</h1>
              <p className="text-xs opacity-80">
                {profile.nome} ‚Äî {profile.cidade}/{profile.estado} ‚Ä¢ Vara {profile.court||"n√£o definida"}
              </p>
            </div>
          </div>
          <div className="text-xs text-right opacity-80">
            Julgados: {profile.stats?.julgados||0}<br/>
            Acertos: {profile.stats?.acertos||0}<br/>
            Prest√≠gio: {profile.stats?.prestigio||0}
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-slate-900/90 border border-white/10 rounded-3xl p-5">
            <h2 className="text-lg font-semibold mb-3">Fila de processos</h2>
            <div className="max-h-96 overflow-y-auto space-y-3 pr-2">
              {fila.length===0 && (
                <p className="text-xs opacity-70">Nenhum processo na fila para este tribunal.</p>
              )}
              {fila.map(c=>(
                <div key={c.id} className="p-3 rounded-2xl bg-white/5 border border-white/10">
                  <h3 className="text-sm font-semibold mb-1">{c.titulo}</h3>
                  <p className="text-xs opacity-80 mb-2">N√≠vel: {c.dificuldade} ‚Ä¢ Tipo: {c.tipo}</p>
                  <p className="text-xs opacity-70 mb-2 line-clamp-2">{c.resumo}</p>
                  <button
                    onClick={()=>{sons.gavel.play();onSelectCase(c.id);}}
                    className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                  >
                    Julgar agora
                  </button>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-slate-900/90 border border-white/10 rounded-3xl p-5 flex flex-col">
            <h2 className="text-lg font-semibold mb-3">Painel da carreira</h2>
            <p className="text-xs opacity-80 mb-3">
              Acompanhe sua evolu√ß√£o, acesse relat√≥rios e, quando estiver pronto, candidate-se ao STJ.
            </p>
            <button
              onClick={onShowRelatorio}
              className="mb-2 w-full px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm font-semibold"
            >
              Ver relat√≥rio trimestral
            </button>
            <button
              onClick={onSTJ}
              className="w-full px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-sm font-semibold mt-2"
            >
              Candidatar-se ao STJ
            </button>
            <div className="mt-4 text-[10px] opacity-70">
              Simula√ß√£o educacional inspirada em rotinas reais, sem valor jur√≠dico. Ideal para cursos de Direito,
              concursos e treinamento de racioc√≠nio jur√≠dico.
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function JuryGrid({tipoCaso,onDeliberar,vereditoFinal}){
  const [resultado,setResultado] = useState(null);

  function iniciar(){
    if(tipoCaso!=="criminal"){
      alert("Neste tipo de processo (fam√≠lia ou trabalhista) n√£o h√° j√∫ri popular. A decis√£o √© exclusiva do juiz.");
      return;
    }
    let votosCulpado = 0;
    let votosInocente = 0;
    JURY_AVATARS.forEach((_,idx)=>{
      const voto = Math.random()>0.5 ? "culpado" : "inocente";
      if(voto==="culpado") votosCulpado++; else votosInocente++;
    });
    const vencedor = votosCulpado>votosInocente ? "culpado" : "inocente";
    setResultado({votosCulpado,votosInocente,vencedor});
    if(onDeliberar) onDeliberar(vencedor==="culpado");
  }

  return (
    <div className="bg-slate-900/90 border border-white/10 rounded-3xl p-4 mt-4">
      <h3 className="text-sm font-semibold mb-2">J√∫ri Popular</h3>
      <div className="grid grid-cols-6 gap-2 mb-3">
        {JURY_AVATARS.map((src,idx)=>(
          <div key={src} className="flex flex-col items-center">
            <div className="w-8 h-8 rounded-full overflow-hidden border border-white/40 mb-1">
              <img src={src} alt={`Jurad@ ${idx+1}`} className="w-full h-full object-cover" />
            </div>
            <span className="text-[9px] opacity-70">J{idx+1}</span>
          </div>
        ))}
      </div>
      <button
        onClick={iniciar}
        className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
      >
        Iniciar delibera√ß√£o do j√∫ri
      </button>
      {resultado && (
        <p className="text-[11px] opacity-80 mt-2">
          Votos culpado: {resultado.votosCulpado} ‚Ä¢ Votos inocente: {resultado.votosInocente} ‚Ä¢
          Resultado simb√≥lico: <b>{resultado.vencedor==="culpado"?"tend√™ncia √† condena√ß√£o":"tend√™ncia √† absolvi√ß√£o"}</b>.
        </p>
      )}
      {vereditoFinal!=null && (
        <p className="text-[11px] opacity-90 mt-1">
          Veredito do juiz nesta simula√ß√£o: <b>{vereditoFinal?"Condenar":"Absolver"}</b>.
        </p>
      )}
    </div>
  );
}

function TypewriterText({text}){
  const [shown,setShown] = useState("");
  useEffect(()=>{
    let i = 0;
    const id = setInterval(()=>{
      setShown(text.slice(0,i));
      i++;
      if(i>text.length) clearInterval(id);
    },18);
    return ()=>clearInterval(id);
  },[text]);
  return <p className="typewriter text-sm opacity-90">{shown}</p>;
}

function Julgamento({caso,onVoltar,onDecisao,profile,sons}){
  const [falas,setFalas] = useState([]);
  const [pergunta,setPergunta] = useState("");
  const [docAberto,setDocAberto] = useState(null);
  const [vereditoFinal,setVereditoFinal] = useState(null);

  async function ouvir(ag){
    const fala = await iaFala(ag,caso,"");
    setFalas(f=>[...f,{autor:ag,texto:fala}]);
    sons.murmur.play();
  }

  async function perguntarIA(){
    if(!pergunta.trim()) return;
    const fala = await iaFala("testemunha",caso,pergunta);
    setFalas(f=>[
      ...f,
      {autor:"juiz",texto:"PERGUNTA DO JUIZ: "+pergunta},
      {autor:"testemunha",texto:fala}
    ]);
    setPergunta("");
    sons.murmur.play();
  }

  function decidir(decisao){
    const acertou = decisao===caso.gabarito.culpado;
    setVereditoFinal(decisao);
    onDecisao(decisao,acertou,caso);
  }

  function abrirDoc(tipo){
    if(!caso.docs) return;
    setDocAberto({tipo,conteudo: caso.docs[tipo]});
  }

  return (
    <div
      className="min-h-screen relative text-white"
      style={{backgroundImage:"url('saladejulgamento.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="absolute inset-0 bg-black/75 backdrop-blur-sm"></div>
      {docAberto && (
        <ProvaViewer
          tipo={docAberto.tipo}
          conteudo={docAberto.conteudo}
          onClose={()=>setDocAberto(null)}
        />
      )}
      <div className="relative z-10 max-w-6xl mx-auto p-6">
        <button
          onClick={onVoltar}
          className="mb-4 px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
        >
          Voltar ao escrit√≥rio
        </button>

        <div className="flex items-center gap-3 mb-2">
          <div className="w-12 h-12 rounded-2xl overflow-hidden border border-emerald-400/60">
            <img src={`avatar${profile.avatar||1}.jpg`} alt="Juiz" className="w-full h-full object-cover" />
          </div>
          <div>
            <h1 className="text-xl font-bold">Sala de Julgamento</h1>
            <p className="text-xs opacity-80">
              Julgando: {caso.titulo} ‚Ä¢ {caso.tipo.toUpperCase()} ‚Ä¢ N√≠vel {caso.dificuldade}
            </p>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-3">
          <div className="lg:col-span-2 space-y-3">
            <div className="bg-slate-900/90 rounded-3xl border border-white/10 p-4">
              <h2 className="text-sm font-semibold mb-1">Audi√™ncia</h2>

              <div className="flex items-center gap-2 mb-2">
                <div className="w-8 h-8 rounded-full overflow-hidden border border-red-400/70">
                  <img src="promotor.jpg" alt="Promotor" className="w-full h-full object-cover" />
                </div>
                <button
                  onClick={()=>ouvir("acusacao")}
                  className="px-3 py-1 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold"
                >
                  Ouvir acusa√ß√£o
                </button>
                <div className="w-8 h-8 rounded-full overflow-hidden border border-emerald-400/70 ml-2">
                  <img src="advogado.jpg" alt="Defesa" className="w-full h-full object-cover" />
                </div>
                <button
                  onClick={()=>ouvir("defesa")}
                  className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                >
                  Ouvir defesa
                </button>

                <div className="w-8 h-8 rounded-full overflow-hidden border border-sky-400/70 ml-2">
                  <img src="testemunha.jpg" alt="Testemunha" className="w-full h-full object-cover" />
                </div>
                <button
                  onClick={()=>ouvir("testemunha")}
                  className="px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold"
                >
                  Ouvir testemunha
                </button>
              </div>

              <div className="space-y-2 max-h-56 overflow-y-auto pr-1">
                {falas.length===0 && (
                  <p className="text-xs opacity-70">
                    Utilize os bot√µes acima para ouvir a acusa√ß√£o, a defesa e a testemunha.
                    As falas aparecer√£o aqui em formato de texto corrido.
                  </p>
                )}
                {falas.map((f,idx)=>(
                  <div key={idx} className="text-xs">
                    <TypewriterText text={f.texto} />
                  </div>
                ))}
              </div>

              <div className="mt-3 flex gap-2">
                <input
                  className="flex-1 px-3 py-2 rounded-xl bg-slate-800 text-xs outline-none"
                  placeholder="Pergunta do juiz para a testemunha..."
                  value={pergunta}
                  onChange={e=>setPergunta(e.target.value)}
                  onKeyDown={e=>{if(e.key==="Enter") perguntarIA();}}
                />
                <button
                  onClick={perguntarIA}
                  className="px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold"
                >
                  Perguntar
                </button>
              </div>
            </div>

            <JuryGrid
              tipoCaso={caso.tipo}
              onDeliberar={()=>{}}
              vereditoFinal={vereditoFinal}
            />
          </div>

          <div className="space-y-3">
            <div className="bg-slate-900/90 rounded-3xl border border-white/10 p-4">
              <h2 className="text-sm font-semibold mb-2">Dossi√™ (Provas)</h2>
              <div className="space-y-2 text-xs">
                <button
                  onClick={()=>abrirDoc("bo")}
                  className="w-full px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left"
                >
                  üìÑ Boletim de ocorr√™ncia
                </button>
                <button
                  onClick={()=>abrirDoc("laudo")}
                  className="w-full px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left"
                >
                  üî¨ Laudo pericial
                </button>
                <button
                  onClick={()=>abrirDoc("pericia")}
                  className="w-full px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-left"
                >
                  üß™ Per√≠cia complementar
                </button>
              </div>
            </div>

            <div className="bg-slate-900/90 rounded-3xl border border-white/10 p-4">
              <h2 className="text-sm font-semibold mb-2">Veredito do Juiz</h2>
              <p className="text-[11px] opacity-80 mb-3">
                Ap√≥s analisar as provas e ouvir as partes, decida se o r√©u deve ser condenado ou absolvido.
              </p>
              <div className="flex flex-col gap-2">
                <button
                  onClick={()=>decidir(true)}
                  className="px-3 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold"
                >
                  Condenar
                </button>
                <button
                  onClick={()=>decidir(false)}
                  className="px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                >
                  Absolver
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* -------------------- TELA EXAME STJ -------------------- */

const STJ_QUESTOES = [
  {
    enunciado:"O STJ julga, em regra, recursos especiais que discutem:",
    alternativas:[
      "Controv√©rsia sobre lei federal.",
      "Constitucionalidade de emenda constitucional.",
      "Cria√ß√£o de munic√≠pios.",
      "Crime de responsabilidade do Presidente."
    ],
    correta:0
  },
  {
    enunciado:"O julgamento colegiado no STJ √© realizado, em regra:",
    alternativas:[
      "Pelo Plen√°rio do STF.",
      "Por Turmas e Se√ß√µes especializadas.",
      "Por j√∫ri popular.",
      "Por varas criminais de 1¬™ inst√¢ncia."
    ],
    correta:1
  },
  {
    enunciado:"A fun√ß√£o do precedente qualificado √©:",
    alternativas:[
      "Vincular decis√µes posteriores em casos semelhantes.",
      "Substituir completamente a lei escrita.",
      "Apenas servir como orienta√ß√£o sem qualquer efeito.",
      "Criar compet√™ncia origin√°ria do STJ."
    ],
    correta:0
  },
  {
    enunciado:"Em recursos especiais repetitivos, o STJ busca:",
    alternativas:[
      "Analisar apenas um caso sem impacto nos demais.",
      "Uniformizar a interpreta√ß√£o da lei federal.",
      "Julgar exclusivamente mat√©rias constitucionais.",
      "Atuar como tribunal de 1¬™ inst√¢ncia."
    ],
    correta:1
  },
  {
    enunciado:"Sobre a atua√ß√£o do relator no STJ, √© correto afirmar que:",
    alternativas:[
      "Pode decidir monocraticamente alguns recursos.",
      "N√£o pode jamais decidir sozinho.",
      "√â obrigado a ouvir o j√∫ri popular.",
      "Julga apenas processos criminais."
    ],
    correta:0
  }
];

function STJExam({profile,onFinish}){
  const [respostas,setRespostas] = useState({});
  const [enviado,setEnviado] = useState(false);

  function toggle(qIdx,altIdx){
    if(enviado) return;
    setRespostas(r=>({...r,[qIdx]:altIdx}));
  }

  function corrigir(){
    let acertos = 0;
    STJ_QUESTOES.forEach((q,idx)=>{
      if(respostas[idx]===q.correta) acertos++;
    });
    setEnviado(true);
    const aprovado = acertos>=4;
    onFinish(aprovado,acertos);
  }

  return (
    <div
      className="min-h-screen flex items-center justify-center text-white"
      style={{backgroundImage:"url('stj.jpg')",backgroundSize:"cover",backgroundPosition:"center"}}
    >
      <div className="bg-black/80 max-w-3xl w-full mx-4 p-6 rounded-3xl border border-yellow-400/60 backdrop-blur">
        <h2 className="text-2xl font-bold mb-1 text-center">Prova R√°pida ‚Äì STJ</h2>
        <p className="text-xs opacity-80 mb-4 text-center">
          Juiz(a) {profile.nome}, responda √†s quest√µes abaixo sobre funcionamento do STJ.
          √â necess√°rio acertar pelo menos 4 para ser promovido.
        </p>

        <div className="max-h-[60vh] overflow-y-auto pr-2 space-y-4 text-xs">
          {STJ_QUESTOES.map((q,idx)=>(
            <div key={idx} className="bg-white/5 rounded-2xl p-3">
              <p className="font-semibold mb-2">{idx+1}. {q.enunciado}</p>
              <div className="space-y-1">
                {q.alternativas.map((alt,aIdx)=>(
                  <label key={aIdx} className="flex items-start gap-2 cursor-pointer">
                    <input
                      type="radio"
                      className="mt-0.5"
                      checked={respostas[idx]===aIdx}
                      onChange={()=>toggle(idx,aIdx)}
                      disabled={enviado}
                    />
                    <span>{alt}</span>
                  </label>
                ))}
              </div>
            </div>
          ))}
        </div>

        {!enviado && (
          <button
            onClick={corrigir}
            className="mt-4 w-full px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-sm font-semibold"
          >
            Enviar prova
          </button>
        )}
      </div>
    </div>
  );
}

/* -------------------- APP PRINCIPAL -------------------- */

function App(){
  const [screen,setScreen] = useState("splash");
  const [profiles,setProfiles] = useState(()=>{
    try{
      return JSON.parse(localStorage.getItem("juiz_profiles_v7")||"{}");
    }catch(e){return {};}
  });
  const [currentProfileId,setCurrentProfileId] = useState(null);
  const [cases,setCases] = useState(()=>seedCases());
  const [currentCaseId,setCurrentCaseId] = useState(null);
  const [showRelatorio,setShowRelatorio] = useState(false);
  const [stjMode,setStjMode] = useState(false);

  const sons = {
    gavel: useSound(SOUND_URLS.gavel,true,0.7),
    murmur: useSound(SOUND_URLS.murmur,true,0.5)
  };

  const currentProfile = currentProfileId ? profiles[currentProfileId] : null;
  const currentCase = currentCaseId ? cases.find(c=>c.id===currentCaseId) : null;

  function saveProfiles(updated){
    setProfiles(updated);
    localStorage.setItem("juiz_profiles_v7",JSON.stringify(updated));
  }

  function updateCurrentProfile(updater){
    if(!currentProfile) return;
    setProfiles(prev=>{
      const p = {...prev[currentProfileId]};
      updater(p);
      const next = {...prev,[currentProfileId]:p};
      localStorage.setItem("juiz_profiles_v7",JSON.stringify(next));
      return next;
    });
  }

  function handleSTJButton(){
    if(!currentProfile) return;
    const s = currentProfile.stats||{};
    if((s.prestigio||0) < 40 || (s.julgados||0) < 20){
      alert("Para se candidatar ao STJ √© necess√°rio, nesta simula√ß√£o, ter pelo menos 20 casos julgados e 40 pontos de prest√≠gio.");
      return;
    }
    setStjMode(true);
    setScreen("stj_exam");
  }

  function handleSTJFinish(aprovado,acertos){
    if(aprovado){
      updateCurrentProfile(p=>{
        p.court = "stj";
        p.stats.prestigio = (p.stats.prestigio||0) + 20;
      });
      alert("Parab√©ns! Voc√™ foi aprovado no exame do STJ com " + acertos + " acertos.");
      setScreen("office");
    }else{
      alert("Voc√™ acertou " + acertos + " quest√µes. Nesta simula√ß√£o, √© necess√°rio ao menos 4 para aprova√ß√£o. Continue estudando!");
      setScreen("office");
    }
  }

  function onDecisaoCaso(decisao,acertou,caso){
    setCases(prev=>prev.map(c=>{
      if(c.id!==caso.id) return c;
      return {...c,status: decisao ? "condenado":"absolvido"};
    }));
    updateCurrentProfile(p=>{
      const s = p.stats||{};
      s.julgados = (s.julgados||0)+1;
      if(decisao) s.condenacoes = (s.condenacoes||0)+1;
      else s.absolvicoes = (s.absolvicoes||0)+1;
      if(acertou){
        s.acertos = (s.acertos||0)+1;
        s.prestigio = (s.prestigio||0)+3;
      }else{
        s.prestigio = Math.max(0,(s.prestigio||0)-2);
      }
      p.stats = s;
    });
  }

  /* ----- ROTAS DE TELA ----- */

  if(screen==="splash"){
    return <SplashScreen onStart={()=>setScreen("tutorial")} />;
  }

  if(screen==="tutorial"){
    return <TutorialSalvamento onContinuar={()=>setScreen("login")} />;
  }

  if(screen==="login"){
    return (
      <LoginScreen
        profiles={profiles}
        setProfiles={setProfiles}
        setCurrentProfile={setCurrentProfileId}
        onEnter={(profile)=>{
          setCurrentProfileId(profile.nome);
          if(!profile.avatar){
            setScreen("avatar");
          }else if(!profile.court){
            setScreen("court");
          }else{
            setScreen("location");
          }
        }}
      />
    );
  }

  if(screen==="avatar" && currentProfile){
    return (
      <AvatarSelect
        onChoose={(idx)=>{
          updateCurrentProfile(p=>{p.avatar = idx;});
          setScreen("court");
        }}
      />
    );
  }

  if(screen==="court" && currentProfile){
    return (
      <CourtSelectScreen
        profile={currentProfile}
        onSelectCourt={(court)=>{
          updateCurrentProfile(p=>{p.court = court;});
          setScreen("location");
        }}
      />
    );
  }

  if(screen==="location" && currentProfile){
    return (
      <LocationSelect
        profile={currentProfile}
        onSelectLocation={(estado,cidade)=>{
          updateCurrentProfile(p=>{
            p.estado = estado;
            p.cidade = cidade;
          });
          setScreen("office");
        }}
      />
    );
  }

  if(screen==="office" && currentProfile){
    return (
      <>
        <Escritorio
          profile={currentProfile}
          cases={cases}
          onSelectCase={(id)=>{setCurrentCaseId(id);setScreen("trial");}}
          onSTJ={handleSTJButton}
          onShowRelatorio={()=>setShowRelatorio(true)}
          sons={sons}
        />
        {showRelatorio && (
          <RelatorioModal
            profile={currentProfile}
            onClose={()=>setShowRelatorio(false)}
          />
        )}
      </>
    );
  }

  if(screen==="trial" && currentProfile && currentCase){
    return (
      <Julgamento
        profile={currentProfile}
        caso={currentCase}
        onVoltar={()=>setScreen("office")}
        onDecisao={onDecisaoCaso}
        sons={sons}
      />
    );
  }

  if(screen==="stj_exam" && currentProfile){
    return (
      <STJExam
        profile={currentProfile}
        onFinish={handleSTJFinish}
      />
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white">
      <div className="text-center">
        <p>Carregando simulador...</p>
        <button
          className="mt-3 px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm"
          onClick={()=>setScreen("splash")}
        >
          Voltar ao in√≠cio
        </button>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
